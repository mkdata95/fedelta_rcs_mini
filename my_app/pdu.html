<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PDU 관리 - RCS 컨트롤 시스템</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <!-- 폰트어썸 아이콘 프리로드 -->
  <link rel="preload" href="assets/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="assets/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
  <!-- CSS 파일 -->
  <link rel="stylesheet" href="assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/css/fontawesome.min.css">
  <link rel="stylesheet" href="assets/css/adminlte.min.css">
  <link rel="stylesheet" href="assets/css/common.css">
  <link rel="stylesheet" href="assets/css/icons.css">
  <link rel="stylesheet" href="assets/css/styles.css">
  <link rel="stylesheet" href="assets/css/components.css">
  <link rel="stylesheet" href="assets/css/pdu.css">
  <!-- 자바스크립트 파일 -->
  <script src="assets/js/common.js"></script>
  <script>
    // 최근 제어된 PDU 상태를 저장하는 객체
    window.lastControlledPDUs = {};
  </script>
  <style>
    /* Skydash Dark 테마 스타일 */
    body {
      background-color: #191c24;
      color: #e9ecef;
      font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
    }
    
    /* 모달 스타일 */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 9999;
    }
    
    .modal.show {
      display: block;
    }
    
    /* 커스텀 모달 스타일 */
    .js-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
    }
    
    .js-modal.active {
      display: block;
    }
    
    .js-modal-dialog {
      position: relative;
      width: 90%;
      max-width: 500px;
      margin: 100px auto;
    }
    
    .modal-dialog {
      position: relative;
      width: auto;
      margin: 100px auto;
      max-width: 500px;
    }
    
    .modal-content {
      position: relative;
      background-color: #191c24;
      border-radius: 0.3rem;
      border: 1px solid #2c2e33;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
    }
    
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      border-bottom: 1px solid #2c2e33;
      background-color: #0090e7;
      color: white;
      border-top-left-radius: 0.3rem;
      border-top-right-radius: 0.3rem;
    }
    
    .modal-title {
      margin: 0;
      font-size: 1.25rem;
    }
    
    .modal-body {
      padding: 1rem;
      color: #e9ecef;
    }
    
    .modal-footer {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 1rem;
      border-top: 1px solid #2c2e33;
    }
    
    .close {
      float: right;
      font-size: 1.5rem;
      font-weight: 700;
      line-height: 1;
      color: white;
      text-shadow: none;
      opacity: .5;
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
    }
    
    .close:hover {
      opacity: 1;
    }

    /* 네비게이션 바 */
    .main-header {
      background-color: #191c24 !important;
      border-bottom: 1px solid #2c2e33;
    }

    /* 사이드바 스타일 */
    .main-sidebar {
      background-color: #191c24;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      width: 250px;
    }
    
    .brand-link {
      background-color: #191c24;
      border-bottom: 1px solid #2c2e33;
    }
    
    .brand-text {
      color: #e9ecef;
    }
    
    .sidebar {
      background-color: #191c24;
    }
    
    .nav-sidebar .nav-link {
      color: #e9ecef;
      border-radius: 5px;
      margin: 0 10px;
      transition: all 0.3s;
    }
    
    .nav-sidebar .nav-link:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .nav-sidebar .nav-link.active {
      background-color: #0090e7;
    }
    
    /* 콘텐츠 래퍼 */
    .content-wrapper {
      background-color: #0c1427;
      margin-left: 250px;
      padding-left: 20px;
      padding-right: 20px;
      padding-top: 70px;
    }
    
    /* 콘텐츠 헤더 */
    .content-header {
      border-bottom: 1px solid #2c2e33;
    }
    
    .content-header h1 {
      color: #e9ecef;
    }

    /* PDU 관리 특화 스타일 */
    .btn-add-pdu {
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      background-color: #0090e7;
      border-color: #0090e7;
      box-shadow: 0 2px 4px rgba(0, 144, 231, 0.3);
    }
    
    .btn-add-pdu:hover {
      background-color: #0083d3;
      border-color: #0083d3;
      box-shadow: 0 3px 6px rgba(0, 144, 231, 0.4);
    }
    
    .btn-add-pdu i {
      margin-right: 8px;
    }
    
    /* 카드 스타일 */
    .card {
      background: #191c24;
      border: none;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      margin-bottom: 20px;
    }
    
    .card-header {
      padding: 1rem;
      background-color: #191c24;
      border-bottom: 1px solid #2c2e33;
      color: #e9ecef;
    }
    
    .card-title {
      font-size: 1.1rem;
      margin: 0;
      color: #e9ecef;
    }
    
    .card-body {
      color: #e9ecef;
      padding: 1.25rem;
    }
    
    /* 향상된 토글 스위치 스타일 */
    .custom-switch .custom-control-label::before {
      width: 2.5rem;
      height: 1.25rem;
      border-radius: 0.625rem;
      cursor: pointer;
      background-color: #2A3038;
      border-color: #2c2e33;
    }
    
    .custom-switch .custom-control-label::after {
      top: calc(0.25rem + 2px);
      left: calc(-2.5rem + 2px);
      width: calc(1.25rem - 4px);
      height: calc(1.25rem - 4px);
      border-radius: 0.625rem;
      cursor: pointer;
      background-color: #6c7293;
    }
    
    .custom-switch .custom-control-input:checked ~ .custom-control-label::after {
      transform: translateX(1.25rem);
      background-color: #191c24;
    }
    
    .custom-switch .custom-control-input:checked ~ .custom-control-label::before {
      background-color: #0090e7;
      border-color: #0090e7;
    }
    
    /* PDU 포트 스타일 */
    .pdu-port {
      border: 1px solid #2c2e33;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: #191c24;
      text-align: center;
      transition: all 0.3s ease;
      color: #e9ecef;
    }
    
    .pdu-port.on {
      background-color: rgba(0, 210, 91, 0.2);
      border-color: #00d25b;
    }
    
    .pdu-port.off {
      background-color: rgba(252, 66, 74, 0.2);
      border-color: #fc424a;
    }
    
    /* 테이블 스타일 개선 */
    .table {
      color: #e9ecef;
      background: transparent;
    }
    
    .table th {
      background-color: #191c24;
      border-color: #2c2e33;
      color: #e9ecef;
      font-weight: 500;
    }
    
    .table td {
      border-color: #2c2e33;
    }
    
    .table tr:hover {
      background-color: rgba(0, 0, 0, 0.2);
    }
    
    /* 컨트롤 버튼 스타일 */
    .control-btn {
      padding: 0.3rem 0.6rem;
      font-size: 0.825rem;
      margin-right: 0.2rem;
      margin-bottom: 0.2rem;
      min-width: 5.5rem;
      position: relative;
      transition: all 0.2s;
    }
    
    .control-btn:disabled {
      cursor: not-allowed;
    }
    
    .control-btn:disabled::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.15);
      border-radius: 4px;
    }

    /* 켜기 버튼 스타일 */
    .control-btn.btn-success {
      background-color: #00d25b;
      border-color: #00d25b;
      box-shadow: 0 2px 4px rgba(0, 210, 91, 0.3);
    }

    .control-btn.btn-success:hover:not(:disabled) {
      background-color: #00ba51;
      border-color: #00ba51;
      box-shadow: 0 3px 6px rgba(0, 210, 91, 0.4);
    }

    .control-btn.btn-success:active:not(:disabled) {
      background-color: #00ba51;
      border-color: #00ba51;
      box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.2);
    }

    /* 끄기 버튼 스타일 */
    .control-btn.btn-danger {
      background-color: #fc424a;
      border-color: #fc424a;
      box-shadow: 0 2px 4px rgba(252, 66, 74, 0.3);
    }

    .control-btn.btn-danger:hover:not(:disabled) {
      background-color: #e33842;
      border-color: #e33842;
      box-shadow: 0 3px 6px rgba(252, 66, 74, 0.4);
    }

    .control-btn.btn-danger:active:not(:disabled) {
      background-color: #e33842;
      border-color: #e33842;
      box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.2);
    }

    /* 관리 버튼 스타일 */
    .control-btn.btn-info {
      background-color: #0090e7;
      border-color: #0090e7;
      box-shadow: 0 2px 4px rgba(0, 144, 231, 0.3);
    }

    .control-btn.btn-info:hover:not(:disabled) {
      background-color: #0083d3;
      border-color: #0083d3;
      box-shadow: 0 3px 6px rgba(0, 144, 231, 0.4);
    }

    .control-btn.btn-info:active:not(:disabled) {
      background-color: #0083d3;
      border-color: #0083d3;
      box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.2);
    }

    /* 삭제 버튼 스타일 */
    .control-btn.btn-secondary {
      background-color: #6c7293;
      border-color: #6c7293;
      color: white;
      box-shadow: 0 2px 4px rgba(108, 114, 147, 0.3);
    }

    .control-btn.btn-secondary:hover:not(:disabled) {
      background-color: #5e6384;
      border-color: #5e6384;
      box-shadow: 0 3px 6px rgba(108, 114, 147, 0.4);
    }

    .control-btn.btn-secondary:active:not(:disabled) {
      background-color: #5e6384;
      border-color: #5e6384;
      box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.2);
    }
    
    /* 상태 배지 스타일 */
    .badge-power-on,
    .badge-online,
    .badge-success {
      background-color: #00d25b;
      color: #191c24;
      font-weight: 600;
    }
    
    .badge-power-off,
    .badge-offline,
    .badge-secondary {
      background-color: #fc424a;
      color: white;
      font-weight: 600;
    }
    
    .badge-warming,
    .badge-warning,
    .badge-starting {
      background-color: #ffab00;
      color: #191c24;
      font-weight: 600;
    }
    
    .badge-cooling,
    .badge-shutting_down,
    .badge-info {
      background-color: #0090e7;
      color: white;
      font-weight: 600;
    }
    
    .badge-rebooting {
      background-color: #6f42c1;
      color: white;
      font-weight: 600;
    }

    /* 토스트 메시지 스타일 */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      bottom: 30px;
      background: #191c24;
      color: #fff;
      padding: 12px 20px;
      border-radius: 4px;
      font-size: 14px;
      z-index: 10000;
      box-shadow: 0 5px 12px rgba(0, 0, 0, 0.2);
      border-left: 4px solid #0090e7;
    }

    .toast-success {
      border-left-color: #00d25b;
    }

    .toast-error {
      border-left-color: #fc424a;
    }
    
    /* PDU 스케줄 관련 스타일 보강 */
    .schedule-card {
      border-top: 3px solid #0090e7;
      margin-bottom: 20px;
      border: none;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      background-color: #191c24 !important;
    }
    
    .schedule-card .card-body {
      background-color: #191c24;
    }
    
    .section-divider {
      font-weight: 600;
      color: #000000; /* 섹션 제목 색상을 검정색으로 유지 */
      background-color: transparent; /* 배경색 제거 */
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      margin: 1rem 0;
      font-size: 0.95rem;
    }
    
    .section-divider h5 {
      color: #e9ecef;
      font-size: 1rem;
      margin: 0;
      padding-left: 5px;
      text-align: center;
    }
    
    /* 컨트롤 버튼 컨테이너 */
    .control-buttons, .settings-buttons {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 4px;
    }

    /* 상태 표시기 */
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }

    .status-indicator.online {
      background-color: #00d25b;
      box-shadow: 0 0 5px #00d25b;
    }

    .status-indicator.offline {
      background-color: #fc424a;
      box-shadow: 0 0 5px #fc424a;
    }

    /* PDU 추가 모달 인라인 스타일 대신에 스타일시트에 명시적으로 추가 */
    #addPDUModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      overflow: auto;
    }

    #addPDUModal.active {
      display: block !important;
    }

    .js-modal-dialog {
      position: relative;
      width: 90%;
      max-width: 500px;
      margin: 100px auto;
      background-color: #191c24;
      border-radius: 5px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      border: 1px solid #2c2e33;
    }

    .js-modal-header {
      background-color: #0090e7;
      color: white;
      border-bottom: 1px solid #2c2e33;
      border-top-left-radius: 5px;
      border-top-right-radius: 5px;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .js-modal-title {
      margin: 0;
      font-size: 18px;
      font-weight: 500;
    }

    .js-modal-close {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      font-weight: bold;
      opacity: 0.8;
      cursor: pointer;
    }

    .js-modal-close:hover {
      opacity: 1;
    }

    .js-modal-body {
      padding: 20px;
      color: #e9ecef;
      background-color: #191c24;
    }

    .js-modal-footer {
      padding: 15px;
      border-top: 1px solid #2c2e33;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      background-color: #191c24;
    }

    .js-form-group {
      margin-bottom: 20px;
    }

    .js-form-group label {
      display: block;
      margin-bottom: 8px;
      color: #e9ecef;
      font-weight: 500;
    }

    .js-form-control {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #2c2e33;
      border-radius: 4px;
      background-color: #2A3038;
      color: #e9ecef;
      font-size: 14px;
    }

    .js-form-control:focus {
      border-color: #0090e7;
      box-shadow: 0 0 0 0.2rem rgba(0, 144, 231, 0.25);
      outline: none;
    }

    .js-form-control.error {
      border-color: #fc424a;
    }

    .js-error-message {
      display: none;
      color: #fc424a;
      font-size: 12px;
      margin-top: 5px;
    }

    /* 버튼 스타일 재정의 */
    .js-modal-footer .btn-secondary {
      background-color: #6c7293;
      border-color: #6c7293;
      color: white;
    }

    .js-modal-footer .btn-secondary:hover {
      background-color: #5e6384;
      border-color: #5e6384;
    }

    .js-modal-footer .btn-primary {
      background-color: #0090e7;
      border-color: #0090e7;
    }

    .js-modal-footer .btn-primary:hover {
      background-color: #0083d3;
      border-color: #0083d3;
    }

    /* 테이블 내부 여백 조정 */
    .table th, .table td {
      padding: 0.75rem 0.5rem;
    }

    /* 카드 내부 여백 조정 */
    .card-body {
      padding: 1.25rem;
    }
    
    /* 폼 컨트롤 스타일 */
    .form-control {
      background-color: #2A3038;
      border-color: #2c2e33;
      color: #e9ecef;
    }
    
    .form-control:focus {
      background-color: #2A3038;
      border-color: #0090e7;
      color: #e9ecef;
    }
    
    /* 유틸리티 클래스 */
    .text-center {
      text-align: center;
    }
    
    .align-middle {
      vertical-align: middle;
    }
    
    /* 로딩 스피너 스타일 */
    .loading-spinner {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }

    .loading-spinner p {
      color: white;
      margin-top: 10px;
      font-size: 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* 페이지 헤더 */
    .page-header {
      background-color: #0d1528;
      padding: 15px;
      border-bottom: 1px solid #2c2e33;
      margin-bottom: 20px;
    }

    .page-header h1 {
      font-size: 24px;
      color: white;
      margin-bottom: 0;
    }

    .page-header .breadcrumb {
      background-color: transparent;
      margin-bottom: 0;
      padding: 0;
    }

    .page-header .breadcrumb-item a {
      color: #6c757d;
    }

    .page-header .breadcrumb-item.active {
      color: white;
    }
    
    /* 푸터 스타일 */
    .main-footer {
      background-color: #191c24;
      border-top: 1px solid #2c2e33;
      color: #6c757d;
    }
    
    /* 웹뷰 메시지 제거 스크립트 스타일 */
    body::before, 
    body::after, 
    body > *:not(.wrapper):not(script):not(style):not(.js-modal):not(.js-notification),
    body > div:not(.wrapper):not(.js-modal):not(.js-notification),
    #app-header, .app-header, #status-bar, .status-bar, #title-bar, .title-bar,
    #server-status, .server-status,
    div[style*="position: fixed"][style*="top: 0"]:not(.js-modal):not(.js-modal-dialog):not(.js-notification),
    div[style*="position:fixed"][style*="top:0"]:not(.js-modal):not(.js-modal-dialog):not(.js-notification),
    div[style*="background-color"][style*="fixed"]:not(.js-modal):not(.js-modal-dialog):not(.js-notification),
    div[style*="z-index: 9"]:not(.js-modal):not(.js-modal-dialog):not(.js-notification),
    div[style*="z-index:9"]:not(.js-modal):not(.js-modal-dialog):not(.js-notification) {
      display: none !important;
      height: 0 !important;
      visibility: hidden !important;
      opacity: 0 !important;
      position: absolute !important;
      z-index: -9999 !important;
    }
    
    /* 문서와 콘텐츠 상단 여백 제거 */
    html, body, .wrapper {
      margin-top: 0 !important;
      padding-top: 0 !important;
    }
    
    /* 테이블 hover 스타일 수정 */
    .table-hover tbody tr:hover {
      background-color: rgba(0, 0, 0, 0.2) !important;
      color: #e9ecef !important;
    }
    
    /* 테이블 stripe 스타일 오버라이드 */
    .table-striped tbody tr:nth-of-type(odd) {
      background-color: rgba(0, 0, 0, 0.05);
    }
    
    .table-striped tbody tr:nth-of-type(odd):hover {
      background-color: rgba(0, 0, 0, 0.2) !important;
    }
    
    /* 테이블 셀 스타일 */
    .table td, .table th {
      vertical-align: middle;
      border-top: 1px solid #2c2e33;
    }
  </style>
  <script>
    // 웹뷰 메시지 완전히 제거하기 위한 즉시 실행 스크립트
    (function() {
      // 웹뷰 상단 메시지 제거를 위한 스타일 즉시 적용
      var style = document.createElement('style');
      style.textContent = `
        /* 웹뷰 헤더 강제 제거 */
        body::before, 
        body::after, 
        body > *:not(.wrapper):not(script):not(style):not(.js-modal),
        body > div:not(.wrapper):not(.js-modal),
        #app-header, 
        .app-header, 
        #status-bar, 
        .status-bar,
        #title-bar,
        .title-bar,
        #server-status,
        .server-status,
        div[style*="position: fixed"][style*="top: 0"]:not(.js-modal):not(.content-header):not(.main-header):not(.main-sidebar),
        div[style*="position:fixed"][style*="top:0"]:not(.js-modal):not(.content-header):not(.main-header):not(.main-sidebar),
        div[style*="background-color"][style*="fixed"]:not(.js-modal):not(.content-header):not(.main-header):not(.main-sidebar),
        div[style*="z-index: 9"]:not(.js-modal):not(.content-header):not(.main-header):not(.main-sidebar),
        div[style*="z-index:9"]:not(.js-modal):not(.content-header):not(.main-header):not(.main-sidebar) {
          display: none !important;
          height: 0 !important;
          max-height: 0 !important;
          min-height: 0 !important;
          visibility: hidden !important;
          opacity: 0 !important;
          position: absolute !important;
          z-index: -9999 !important;
          overflow: hidden !important;
          pointer-events: none !important;
          margin: 0 !important;
          padding: 0 !important;
          border: none !important;
          transform: translateY(-999px) !important;
          clip: rect(0, 0, 0, 0) !important;
          clip-path: inset(50%) !important;
        }
        
        /* 문서가 상단에서 시작하도록 설정 */
        html, body {
          margin-top: 0 !important;
          padding-top: 0 !important;
        }
        
        /* 웹페이지 내용이 상단에서 시작하도록 설정 */
        .wrapper {
          margin-top: 0 !important;
          padding-top: 0 !important;
        }

        /* 모달 스타일 오버라이드 */
        .js-modal.active {
          display: block !important;
          visibility: visible !important;
          opacity: 1 !important;
          position: fixed !important;
          z-index: 9999 !important;
          transform: none !important;
          clip: auto !important;
          clip-path: none !important;
          height: 100vh !important;
          max-height: none !important;
          min-height: 0 !important;
          overflow: auto !important;
          pointer-events: auto !important;
        }
        
        /* 컨텐츠 헤더 반드시 표시 */
        .content-header {
          display: block !important;
          visibility: visible !important;
          opacity: 1 !important;
          position: relative !important;
          z-index: 1 !important;
          transform: none !important;
          clip: auto !important;
          clip-path: none !important;
          min-height: 50px !important;
          overflow: visible !important;
          pointer-events: auto !important;
        }
      `;
      document.head.appendChild(style);
      
      // DOM이 변경될 때마다 웹뷰 메시지 요소를 찾아 제거
      var observer = new MutationObserver(function(mutations) {
        var selectors = [
          '.webview-message', 
          '.webview-title', 
          '.webview-status',
          '.server-status',
          '.status-bar',
          '.app-title-bar',
          '.app-header-original',
          '[id*="title-container"]',
          '[class*="title-container"]',
          '[id*="server-status"]',
          '[class*="server-status"]',
          '[id*="app-header"]',
          '[class*="app-header"]',
          '.offline-remote-header',
          '#offline-remote-header',
          '.server-status-container',
          '#server-status-container'
        ];
        
        selectors.forEach(function(selector) {
          var elements = document.querySelectorAll(selector);
          elements.forEach(function(el) {
            if(el && el.parentNode) {
              el.style.display = 'none';
              el.style.height = '0';
              el.style.visibility = 'hidden';
              el.style.opacity = '0';
              el.style.position = 'absolute';
              el.style.zIndex = '-9999';
              el.parentNode.removeChild(el);
            }
          });
        });
        
        // 첫 번째 요소가 wrapper가 아니면 제거
        var firstElement = document.body.firstElementChild;
        if(firstElement && !firstElement.classList.contains('wrapper') && 
           !firstElement.tagName.toLowerCase().match(/^(script|style|link|meta)$/)) {
          firstElement.style.display = 'none';
          if(firstElement.parentNode) {
            firstElement.parentNode.removeChild(firstElement);
          }
        }
      });
      
      // document.body가 존재할 때만 observer 시작
      if (document.body) {
        observer.observe(document.body, { childList: true, subtree: true });
        
        // 1초마다 반복 실행하여 웹뷰 메시지 요소 제거
        var interval = setInterval(function() {
          observer.takeRecords(); // 현재까지 발생한 변경 확인
        }, 500);
        
        // 30초 후 interval 정지
        setTimeout(function() {
          clearInterval(interval);
        }, 30000);
      }
    })();

    // 문서 로드 시 타이틀 강제 변경 (웹뷰에서 기본 타이틀이 표시되는 문제 해결)
    document.addEventListener('DOMContentLoaded', function() {
      document.title = "PDU 관리 - RCS 컨트롤 시스템";
      
      // 웹뷰 상단 메시지 숨기기
      hideWebViewHeader();
    });
    
    // 웹뷰 상단 헤더 숨기기 함수
    function hideWebViewHeader() {
      // Android WebView
      if (window.AndroidChannel) {
        try {
          window.AndroidChannel.postMessage('hideHeader:true');
          window.AndroidChannel.postMessage('hideStatusBar:true');
          window.AndroidChannel.postMessage('fullscreen:true');
          window.AndroidChannel.postMessage('hideSystemUI:true');
        } catch (e) {
          console.error('Android WebView 통신 오류:', e);
        }
      }
      
      // iOS WKWebView
      try {
        window.webkit.messageHandlers.hideHeader.postMessage(true);
        window.webkit.messageHandlers.hideStatusBar.postMessage(true);
        window.webkit.messageHandlers.fullscreen.postMessage(true);
        window.webkit.messageHandlers.hideSystemUI.postMessage(true);
      } catch (e) {
        // iOS 핸들러가 없는 경우 무시
      }
      
      // 상단 메시지 요소 직접 숨기기 (content-header는 제외)
      const possibleSelectors = [
        '.webview-message', 
        '.webview-title', 
        '.webview-status',
        '.server-status',
        '.status-bar',
        '.app-title-bar',
        '.app-header-original',
        'div[class*="webview-"]',
        'div[id*="webview-"]',
        'div[id*="header"]:not(.content-header):not(.main-header):not(.card-header)',
        'div[class*="header"]:not(.content-header):not(.main-header):not(.card-header)',
        'div[id*="status"]:not(#server-status-indicator):not(#network-status-indicator)',
        'div[class*="status"]:not(.status-indicator)',
        '.system-message',
        '.system-status',
        '.offline-remote-header',
        '#offline-remote-header',
        '.offline-remote-status',
        '#offline-remote-status',
        '.remote-control-header',
        '#remote-control-header',
        '#app-header',
        '.app-header',
        '#status-bar',
        '.status-bar',
        '#title-bar',
        '.title-bar'
      ];
      
      // 모든 선택자를 대상으로 요소를 찾아 숨김 처리
      possibleSelectors.forEach(selector => {
        const elements = document.querySelectorAll(selector);
        elements.forEach(element => {
          // content-header, main-header, card-header 클래스를 가진 요소는 제외
          if (element.classList && 
              !element.classList.contains('content-header') && 
              !element.classList.contains('main-header') &&
              !element.classList.contains('card-header') &&
              !element.classList.contains('content-wrapper')) {
            // 요소의 스타일 속성 변경
            element.style.display = 'none';
            element.style.height = '0';
            element.style.visibility = 'hidden';
            element.style.opacity = '0';
            element.style.position = 'absolute';
            element.style.zIndex = '-9999';
            
            // 가능하면 DOM에서 제거
            if(element.parentNode) {
              element.parentNode.removeChild(element);
            }
          }
        });
      });
    }
  </script>
  <style>
    /* 로딩 스피너 스타일 */
    .loading-spinner {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }

    .loading-spinner p {
      color: white;
      margin-top: 10px;
      font-size: 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* 상태 변경 애니메이션 */
    .status-changed {
      animation: flash 0.5s;
    }

    @keyframes flash {
      0% { opacity: 0.2; }
      50% { opacity: 1; }
      100% { opacity: 0.2; }
    }

    /* 모달 스타일 */
    .js-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 99999 !important;
      overflow: auto;
    }

    .js-modal.active {
      display: block !important;
    }

    .js-modal-dialog {
      background-color: #fff;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      width: 90%;
      max-width: 600px;
      margin: 50px auto;
      position: relative;
      z-index: 100000 !important;
    }

    .js-modal-header {
      padding: 15px;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .js-modal-title {
      margin: 0;
      font-size: 1.25rem;
    }

    .js-modal-close {
      border: none;
      background: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #aaa;
    }

    .js-modal-body {
      padding: 15px;
    }

    .js-modal-footer {
      padding: 15px;
      border-top: 1px solid #e9ecef;
      display: flex;
      justify-content: flex-end;
    }

    .js-form-group {
      margin-bottom: 1rem;
    }

    .js-form-control {
      display: block;
      width: 100%;
      padding: 0.375rem 0.75rem;
      font-size: 1rem;
      line-height: 1.5;
      color: #495057;
      background-color: #fff;
      background-clip: padding-box;
      border: 1px solid #ced4da;
      border-radius: 0.25rem;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .js-form-control.error {
      border-color: #dc3545;
    }

    .js-error-message {
      display: none;
      color: #dc3545;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    .js-form-control.error + .js-error-message {
      display: block;
    }
  </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">
  <!-- 네비게이션 바 -->
  <nav class="main-header navbar navbar-expand navbar-dark" style="background-color: #191c24 !important; border-bottom: 1px solid #2c2e33;">
    <!-- 좌측 네비게이션 링크 -->
    <ul class="navbar-nav">
      <li class="nav-item">
        <span class="nav-link font-weight-bold">EASYSIGN RCS</span>
      </li>
    </ul>

    <!-- 우측 네비게이션 링크 -->
    <ul class="navbar-nav ml-auto">
      <div id="current-time" class="mr-3 mt-2 text-white"></div>
    </ul>
  </nav>
  <!-- /.navbar -->

  <!-- 메인 사이드바 -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4" style="background-color: #191c24; box-shadow: 0 0 10px rgba(0,0,0,0.2);">
    <!-- 브랜드 로고 -->
    <a href="index.html" class="brand-link" style="background-color: #191c24; border-bottom: 1px solid #2c2e33;">
      <span class="brand-text font-weight-bold ml-3" style="color: #e9ecef;">RCS CONTROL</span>
    </a>

    <!-- 사이드바 -->
    <div class="sidebar" style="background-color: #191c24;">
      <!-- 사이드바 메뉴 -->
      <nav class="mt-3">
        <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
          <li class="nav-item mb-2">
            <a href="javascript:void(0);" onclick="navigateToPage('dashboard.html')" class="nav-link" id="dashboard-link" style="border-radius: 5px; margin: 0 10px; transition: all 0.3s;">
              <i class="nav-icon fas fa-tachometer-alt"></i>
              <p>
                대시보드
              </p>
            </a>
          </li>
          <li class="nav-item mb-2">
            <a href="javascript:void(0);" onclick="navigateToPage('projector.html')" class="nav-link" id="projector-link" style="border-radius: 5px; margin: 0 10px; transition: all 0.3s;">
              <i class="nav-icon fas fa-projector"></i>
              <p>
                빔프로젝터관리
              </p>
            </a>
          </li>
          <li class="nav-item mb-2">
            <a href="javascript:void(0);" onclick="navigateToPage('pc.html')" class="nav-link" id="pc-link" style="border-radius: 5px; margin: 0 10px; transition: all 0.3s;">
              <i class="nav-icon fas fa-desktop"></i>
              <p>
                PC관리
              </p>
            </a>
          </li>
          <li class="nav-item mb-2">
            <a href="javascript:void(0);" onclick="navigateToPage('pdu.html')" class="nav-link active" id="pdu-link" style="background-color: #0090e7; border-radius: 5px; margin: 0 10px;">
              <i class="nav-icon fas fa-plug"></i>
              <p>
                PDU관리
              </p>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </aside>

  <!-- 메인 콘텐츠 -->
  <div class="content-wrapper" style="background-color: #0c1427; padding-top: 70px; margin-left: 260px; overflow-x: hidden;">
    <!-- 콘텐츠 헤더 (페이지 헤더) -->
    <div class="content-header" style="border-bottom: 1px solid #2c2e33;">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0" style="color: #e9ecef;">PDU 관리</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="dashboard.html">홈</a></li>
              <li class="breadcrumb-item active">PDU 관리</li>
            </ol>
          </div>
        </div>
      </div>
    </div>
    
    <section class="content">
      <div class="container-fluid">
        <!-- Removing the PDU 추가 button -->
        <!-- <div class="d-flex justify-content-end mb-3">
          <button type="button" class="btn btn-primary" data-action="open-modal" data-modal="addPDUModal">
            <i class="fas fa-plus mr-1"></i> PDU 추가
          </button>
        </div> -->
        
        <!-- PDU 추가 버튼 복원 -->
        <div class="d-flex justify-content-end mb-3">
          <button type="button" class="btn btn-primary" id="addPDUButton">
            <i class="fas fa-plus mr-1"></i> PDU 추가
          </button>
        </div>

        <!-- PDU 알람 스케줄 설정 패널 -->
        <div class="card schedule-card">
          <div class="card-header">
            <h4 class="card-title mb-0">
              <i class="fas fa-clock mr-2" style="color: #0090e7;"></i>전체 PDU 스케줄 관리
            </h4>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-3">
                <div class="form-group mb-0">
                  <label class="small" style="color: #e9ecef;"><i class="fas fa-play text-success mr-1"></i>켜기 시간</label>
                  <input type="time" class="form-control form-control-sm" value="08:00" id="start-time" style="background-color: #2A3038; border: 1px solid #2c2e33; color: #e9ecef;">
                </div>
              </div>
              <div class="col-3">
                <div class="form-group mb-0">
                  <label class="small" style="color: #e9ecef;"><i class="fas fa-stop text-danger mr-1"></i>끄기 시간</label>
                  <input type="time" class="form-control form-control-sm" value="18:00" id="end-time" style="background-color: #2A3038; border: 1px solid #2c2e33; color: #e9ecef;">
                </div>
              </div>
              <div class="col-3">
                <div class="form-group mb-0">
                  <label class="small" style="color: #e9ecef;"><i class="fas fa-calendar-alt text-primary mr-1"></i>요일</label>
                  <div class="d-flex flex-wrap">
                    <div class="custom-control custom-checkbox mr-1">
                      <input type="checkbox" id="day-1" class="custom-control-input day-checkbox" value="1" checked>
                      <label for="day-1" class="custom-control-label small" style="color: #e9ecef;">월</label>
                    </div>
                    <div class="custom-control custom-checkbox mr-1">
                      <input type="checkbox" id="day-2" class="custom-control-input day-checkbox" value="2" checked>
                      <label for="day-2" class="custom-control-label small" style="color: #e9ecef;">화</label>
                    </div>
                    <div class="custom-control custom-checkbox mr-1">
                      <input type="checkbox" id="day-3" class="custom-control-input day-checkbox" value="3" checked>
                      <label for="day-3" class="custom-control-label small" style="color: #e9ecef;">수</label>
                    </div>
                    <div class="custom-control custom-checkbox mr-1">
                      <input type="checkbox" id="day-4" class="custom-control-input day-checkbox" value="4" checked>
                      <label for="day-4" class="custom-control-label small" style="color: #e9ecef;">목</label>
                    </div>
                    <div class="custom-control custom-checkbox mr-1">
                      <input type="checkbox" id="day-5" class="custom-control-input day-checkbox" value="5" checked>
                      <label for="day-5" class="custom-control-label small" style="color: #e9ecef;">금</label>
                    </div>
                    <div class="custom-control custom-checkbox mr-1">
                      <input type="checkbox" id="day-6" class="custom-control-input day-checkbox" value="6">
                      <label for="day-6" class="custom-control-label small" style="color: #e9ecef;">토</label>
                    </div>
                    <div class="custom-control custom-checkbox">
                      <input type="checkbox" id="day-7" class="custom-control-input day-checkbox" value="0">
                      <label for="day-7" class="custom-control-label small" style="color: #e9ecef;">일</label>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-3">
                <div class="form-group mb-0">
                  <label class="small invisible" style="color: #e9ecef;">적용</label>
                  <div class="d-flex flex-column">
                    <button type="button" class="btn btn-success btn-sm" id="save-schedule-btn" data-action="save-pdu-schedule">
                      <i class="fas fa-check mr-1"></i> 적용
                    </button>
                    <div class="custom-control custom-switch mt-2">
                      <input type="checkbox" class="custom-control-input" id="pdu-schedule-active" checked>
                      <label class="custom-control-label" for="pdu-schedule-active" style="color: #e9ecef;">활성</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 구분선 -->
        <div class="section-divider">
          <h5 style="color: #000000; text-align: center;">PDU 관리</h5>
        </div>

        <!-- PDU 목록 테이블 -->
        <div class="card mt-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">
              <i class="fas fa-plug mr-2" style="color: #0090e7;"></i>PDU 목록
            </h4>
            <button id="add-pdu-btn" class="btn btn-primary btn-sm" data-action="open-add-pdu-modal">
              <i class="fas fa-plus mr-1"></i>PDU 추가
            </button>
          </div>
          <div class="card-body pt-0">
            <div class="table-responsive">
              <table class="table table-hover table-striped">
                <thead class="table-header">
                  <tr>
                    <th class="text-center" width="50">No.</th>
                    <th class="text-center" width="20%">이름</th>
                    <th class="text-center" width="20%">IP 주소</th>
                    <th class="text-center" width="10%">연결 상태</th>
                    <th class="text-center" width="10%">포트</th>
                    <th class="text-center" width="12%">상태</th>
                    <th class="text-center" width="20%">제어</th>
                    <th class="text-center" width="20%">설정</th>
                  </tr>
                </thead>
                <tbody id="pduList">
                  <!-- PDU 목록이 여기에 동적으로 추가됩니다 -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- 푸터 -->
  <footer class="main-footer d-flex justify-content-between align-items-center" style="background-color: #191c24; border-top: 1px solid #2c2e33; color: #6c757d;">
    <div>
      <strong>Copyright © 2025 <a href="#" style="color: #0090e7;">DIDBANK RCS CONTROL</a>.</strong> All rights reserved.
    </div>
    <div class="d-flex align-items-center">
      <span class="mr-4" title="서버 상태">
        <span class="status-indicator online" id="server-status-indicator"></span>
        <span class="server-status-text">서버 정상</span>
      </span>
      <span title="네트워크 상태">
        <span class="status-indicator online" id="network-status-indicator"></span>
        <span class="network-status-text">네트워크 정상</span>
      </span>
    </div>
  </footer>
</div>

<!-- 로딩 스피너 -->
<div id="pduSpinner" class="loading-spinner">
  <div class="spinner"></div>
  <p>로딩 중...</p>
    </div>

<!-- 순수 자바스크립트 모달 -->
<div class="js-modal" id="addPDUModal">
  <div class="js-modal-dialog">
    <div class="js-modal-header">
      <h5 class="js-modal-title">
        <i class="fas fa-plus mr-2"></i>PDU 추가
      </h5>
      <button type="button" class="js-modal-close" data-action="close-modal">&times;</button>
        </div>
    <div class="js-modal-body">
      <form id="add-pdu-form" novalidate>
        <div class="js-form-group">
          <label for="pdu-name">이름</label>
          <input type="text" class="js-form-control bg-dark text-light border-secondary" id="pdu-name" name="pdu-name" placeholder="PDU 이름 입력" required>
          <div class="js-error-message">PDU 이름을 입력해주세요.</div>
        </div>
        <div class="js-form-group">
          <label for="pdu-ip">IP 주소</label>
          <input type="text" class="js-form-control bg-dark text-light border-secondary" id="pdu-ip" name="pdu-ip" placeholder="192.168.0.xxx" 
                 pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" required>
          <div class="js-error-message">올바른 IP 주소 형식으로 입력해주세요.</div>
        </div>
        <div class="js-form-group">
          <label for="pdu-port">포트</label>
          <input type="number" class="js-form-control bg-dark text-light border-secondary" id="pdu-port" name="pdu-port" placeholder="80" value="80" min="1" max="65535" required>
          <div class="js-error-message">올바른 포트 번호를 입력해주세요 (1-65535).</div>
        </div>
        <div class="js-form-group">
          <label for="pdu-model">종류</label>
          <select class="js-form-control bg-dark text-light border-secondary" id="pdu-model" name="pdu-model" required>
            <option value="ATEN PE6108" selected>ATEN PE6108</option>
            <option value="ATEN PE8208">ATEN PE8208</option>
            <option value="ATEN PE7208">ATEN PE7208</option>
            <option value="APC AP7920">APC AP7920</option>
            <option value="OTHER">기타</option>
          </select>
          <div class="js-error-message">PDU 종류를 선택해주세요.</div>
        </div>
        <div class="js-form-group">
          <label for="pdu-username">ID (기본값: administrator)</label>
          <input type="text" class="js-form-control bg-dark text-light border-secondary" id="pdu-username" name="pdu-username" placeholder="입력하지 않으면 기본값 administrator가 사용됩니다" value="administrator">
          <div class="js-error-message">관리자 ID를 입력해주세요.</div>
        </div>
        <div class="js-form-group">
          <label for="pdu-password">비밀번호 (기본값: password)</label>
          <input type="password" class="js-form-control bg-dark text-light border-secondary" id="pdu-password" name="pdu-password" placeholder="입력하지 않으면 기본값 password가 사용됩니다" value="password">
          <div class="js-error-message">비밀번호를 입력해주세요.</div>
        </div>
      </form>
    </div>
    <div class="js-modal-footer" style="background-color: #191c24; border-top: 1px solid #2c2e33;">
      <button type="button" class="btn btn-secondary" data-action="close-modal">취소</button>
      <button type="button" class="btn btn-primary" data-action="add-pdu">추가</button>
    </div>
  </div>
</div>

<!-- PDU 설정(수정) 모달 -->
<div class="js-modal" id="editPDUModal">
  <div class="js-modal-dialog">
    <div class="js-modal-header" style="background-color: #0090e7; color: white;">
      <h5 class="js-modal-title">
        <i class="fas fa-cog mr-2"></i>PDU 설정
      </h5>
      <button type="button" class="js-modal-close" onclick="cancelEditPDU()" style="color: white; opacity: 0.8;">&times;</button>
    </div>
    <div class="js-modal-body" style="background-color: #191c24; color: #e9ecef;">
      <form id="edit-pdu-form" novalidate>
        <input type="hidden" id="edit-pdu-id" name="edit-pdu-id">
        <input type="hidden" id="edit-pdu-uuid" name="edit-pdu-uuid">
        
        <div class="js-form-group">
          <label for="edit-pdu-name">이름</label>
          <input type="text" class="js-form-control bg-dark text-light border-secondary" id="edit-pdu-name" name="edit-pdu-name" placeholder="PDU 이름 입력" required>
          <div class="js-error-message">PDU 이름을 입력해주세요.</div>
        </div>
        <div class="js-form-group">
          <label for="edit-pdu-ip">IP 주소</label>
          <input type="text" class="js-form-control bg-dark text-light border-secondary" id="edit-pdu-ip" name="edit-pdu-ip" placeholder="192.168.0.xxx" 
                 pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" required>
          <div class="js-error-message">올바른 IP 주소 형식으로 입력해주세요.</div>
        </div>
        <div class="js-form-group">
          <label for="edit-pdu-port">포트</label>
          <input type="number" class="js-form-control bg-dark text-light border-secondary" id="edit-pdu-port" name="edit-pdu-port" placeholder="80" value="80" min="1" max="65535" required>
          <div class="js-error-message">올바른 포트 번호를 입력해주세요 (1-65535).</div>
        </div>
        <div class="js-form-group">
          <label for="edit-pdu-model">종류</label>
          <select class="js-form-control bg-dark text-light border-secondary" id="edit-pdu-model" name="edit-pdu-model" required>
            <option value="ATEN PE6108">ATEN PE6108</option>
            <option value="ATEN PE8208">ATEN PE8208</option>
            <option value="ATEN PE7208">ATEN PE7208</option>
            <option value="APC AP7920">APC AP7920</option>
            <option value="OTHER">기타</option>
          </select>
          <div class="js-error-message">PDU 종류를 선택해주세요.</div>
        </div>
        <div class="js-form-group">
          <label for="edit-pdu-username">ID</label>
          <input type="text" class="js-form-control bg-dark text-light border-secondary" id="edit-pdu-username" name="edit-pdu-username" placeholder="ID" value="administrator">
          <div class="js-error-message">관리자 ID를 입력해주세요.</div>
        </div>
        <div class="js-form-group">
          <label for="edit-pdu-password">비밀번호</label>
          <input type="password" class="js-form-control bg-dark text-light border-secondary" id="edit-pdu-password" name="edit-pdu-password" placeholder="비밀번호" value="">
          <div class="js-error-message">비밀번호를 입력해주세요.</div>
        </div>
        <div class="js-form-group">
          <label for="edit-pdu-outlet-count">포트 수</label>
          <input type="number" class="js-form-control bg-dark text-light border-secondary" id="edit-pdu-outlet-count" name="edit-pdu-outlet-count" placeholder="8" value="8" min="1" max="24" required>
          <div class="js-error-message">올바른 포트 수를 입력해주세요 (1-24).</div>
        </div>
      </form>
    </div>
    <div class="js-modal-footer" style="background-color: #191c24; border-top: 1px solid #2c2e33;">
      <button type="button" class="btn btn-secondary" onclick="cancelEditPDU()">취소</button>
      <button type="button" class="btn btn-primary" onclick="saveEditPDU()">저장</button>
    </div>
  </div>
</div>

<!-- AdminLTE 및 의존성 -->
<script>
// 알림 메시지 표시 함수 (전역)
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `js-notification ${type}`;
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  // Force reflow
  notification.offsetHeight;
  
  requestAnimationFrame(() => {
    notification.classList.add('active');
    setTimeout(() => {
      notification.classList.remove('active');
      notification.addEventListener('transitionend', () => {
        notification.remove();
      });
    }, 3000);
  });
}

// PDU 관리 클래스
class PDUManager {
  constructor() {
    this.pdus = [];
    this.isLoading = false;
    this.showSpinner();
  }

  // PDU 목록 로드
  loadPDUList() {
    console.log('[PDU] PDU 목록 로드 시작');
    this.isLoading = true;
    this.showSpinner();
    
    // 이전 데이터 초기화
    this.pdus = [];
    window.pduListReceived = false;
    
    // 안드로이드 환경 감지 - 여러 가능한 브릿지 이름 확인
    const isAndroidWebView = window.AndroidBridge !== undefined || 
                            window.AndroidChannel !== undefined ||
                            window.Android !== undefined;
    console.log('[PDU] 안드로이드 웹뷰 환경:', isAndroidWebView);
    
    if (isAndroidWebView) {
      // 안드로이드에 PDU 목록 요청
      try {
        console.log('[PDU] 안드로이드에 PDU 목록 요청');
        // 여러 가능한 브릿지 이름 시도
        if (window.AndroidBridge && typeof window.AndroidBridge.requestPDUList === 'function') {
          window.AndroidBridge.requestPDUList();
        } else if (window.AndroidChannel && typeof window.AndroidChannel.postMessage === 'function') {
          window.AndroidChannel.postMessage('getPDUList');
        } else if (window.Android && typeof window.Android.requestPDUList === 'function') {
          window.Android.requestPDUList();
        } else {
          console.warn('[PDU] 안드로이드 브릿지가 존재하지만 호출 가능한 메서드를 찾을 수 없음');
          throw new Error('안드로이드 브릿지 메서드를 찾을 수 없음');
        }
        
        // 3초 타임아웃 설정 (응답이 없을 경우 테스트 데이터 표시)
        window.pduListTimer = setTimeout(() => {
          if (!window.pduListReceived) {
            console.warn('[PDU] 안드로이드 응답 타임아웃, 테스트 데이터 표시');
            this.renderTestPDUData();
          }
        }, 3000);
      } catch (error) {
        console.error('[PDU] 안드로이드 통신 오류:', error);
        this.showNotification('안드로이드와 통신 중 오류가 발생했습니다.', 'error');
        this.renderTestPDUData();
      }
    } else {
      // 웹 환경에서는 API 직접 호출
      const fetchOptions = {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' },
        cache: 'no-store'
      };
      
      fetch('/api/pdu/list', fetchOptions)
        .then(response => {
          if (!response.ok) {
            throw new Error(`PDU 목록을 가져오는데 실패했습니다 (${response.status})`);
          }
          return response.json();
        })
        .then(data => {
          console.log('[PDU] PDU 목록 데이터 수신:', data);
          this.updatePDUList(data);
        })
        .catch(error => {
          console.error('[PDU] PDU 목록 로드 오류:', error);
          this.showNotification('PDU 목록을 불러오는데 실패했습니다.', 'error');
          this.hideSpinner();
          this.renderTestPDUData(); // 테스트 데이터 표시
        });
    }
  }
  
  // 테스트 PDU 데이터 렌더링
  renderTestPDUData() {
    console.log('[PDU] 테스트 PDU 데이터 렌더링');
    const testData = [
      {
        id: 1,
        uuid: 'test-pdu-uuid-1',
        name: '테스트 PDU 1',
        ip: '192.168.0.101',
        port: 80,
        status: 'on', // on 또는 off
        networkStatus: 'online', // online 또는 offline
        description: '테스트 PDU 1 설명'
      },
      {
        id: 2,
        uuid: 'test-pdu-uuid-2',
        name: '테스트 PDU 2',
        ip: '192.168.0.102',
        port: 80,
        status: 'off',
        networkStatus: 'offline',
        description: '테스트 PDU 2 설명'
      }
    ];
    
    this.updatePDUList(testData);
  }

  // PDU 목록 업데이트
  updatePDUList(data) {
    console.log('[PDU] PDU 목록 업데이트:', data);
    
    // 현재 PDU 상태 저장 (업데이트 후에도 상태를 유지하기 위해)
    const prevPDUStates = {};
    this.pdus.forEach(pdu => {
      prevPDUStates[pdu.uuid] = {
        status: pdu.status,
        power_status: pdu.power_status,
        networkStatus: pdu.networkStatus,
        network_status: pdu.network_status
      };
    });
    
    // API로 받은 PDU 데이터 처리
    let newPdus = [];
    
    // 새 PDU 목록 설정 - pdus 배열 추출
    if (data && data.pdus && Array.isArray(data.pdus)) {
      newPdus = data.pdus;
    } else if (Array.isArray(data)) {
      newPdus = data;
    } else {
      console.error('[PDU] 잘못된 PDU 데이터 형식:', data);
      newPdus = [];
    }
    
    // 최근 제어된 PDU 상태를 서버 데이터보다 우선시하도록 처리
    this.pdus = newPdus.map(pdu => {
      // 이전 상태 복원 (있는 경우)
      if (pdu.uuid && prevPDUStates[pdu.uuid]) {
        // 네트워크 상태가 없는 경우에만 이전 상태를 사용
        if (!pdu.network_status) {
          pdu.network_status = prevPDUStates[pdu.uuid].network_status || prevPDUStates[pdu.uuid].networkStatus;
        }
        
        // 최근 제어된 PDU인지 확인
        const uniqueId = `pdu-${pdu.uuid.toString().replace(/\W/g, '')}-${(pdu.ip || '').replace(/\./g, '-')}`;
        const lastControlled = window.lastControlledPDUs && window.lastControlledPDUs[uniqueId];
        
        // 최근 제어된 상태가 있고, 현재 시간과 180초(3분) 이내라면 해당 상태 적용 (서버 데이터 무시)
        if (lastControlled && (Date.now() - lastControlled.timestamp < 180000)) {
          console.log(`[PDU] 서버 데이터 무시: PDU ${pdu.name}(${pdu.uuid})의 상태를 최근 제어 상태(${lastControlled.status})로 유지`);
          pdu.status = lastControlled.status;
          pdu.power_status = lastControlled.status;
        } else {
          // 최근 제어된 상태가 없으면 기존 로직 적용
          // power_status 및 status 필드 처리
          if (!pdu.power_status) {
            pdu.power_status = prevPDUStates[pdu.uuid].power_status || prevPDUStates[pdu.uuid].status;
          }
          if (!pdu.status) {
            pdu.status = prevPDUStates[pdu.uuid].status || prevPDUStates[pdu.uuid].power_status;
          }
          
          // power_status와 status가 동기화되도록 보장
          if (pdu.power_status && !pdu.status) {
            pdu.status = pdu.power_status;
          } else if (pdu.status && !pdu.power_status) {
            pdu.power_status = pdu.status;
          }
        }
      }
      return pdu;
    });
    
    // PDU 목록 렌더링
    this.renderPDUList();
    this.hideSpinner();
    this.isLoading = false;
  }
  
  // 스피너 표시
  showSpinner() {
    const spinner = document.getElementById('pduSpinner');
    if (spinner) {
      spinner.style.display = 'flex';
    }
  }
  
  // 스피너 숨기기
  hideSpinner() {
    const spinner = document.getElementById('pduSpinner');
    if (spinner) {
      spinner.style.display = 'none';
    }
  }
  
  // PDU 목록 렌더링
  renderPDUList() {
    console.log('renderPDUList 함수 호출됨');
    
    const pduList = document.getElementById('pduList');
    if (!pduList) {
      console.error('PDU 목록 요소를 찾을 수 없습니다.');
      return;
    }
    
    // PDU 목록 비우기
    pduList.innerHTML = '';
    
    // PDU가 없는 경우 메시지 표시
    if (!this.pdus || this.pdus.length === 0) {
      pduList.innerHTML = `
        <tr>
          <td colspan="8" class="text-center">등록된 PDU가 없습니다.</td>
        </tr>
      `;
      return;
    }
    
    // PDU 목록 표시
    this.pdus.forEach((pdu, index) => {
      const row = document.createElement('tr');
      
      // UUID나 ID를 통해 식별자 생성
      const uniqueId = `pdu-${pdu.uuid || pdu.id}`;
      
      // PDU 데이터 속성 설정
      row.dataset.pduId = pdu.id || '';
      row.dataset.pduUuid = pdu.uuid || '';
      
      // 네트워크 상태 결정
      const networkStatus = pdu.network_status || 'offline';
      const isNetworkConnected = networkStatus === 'online' || networkStatus === 'connected';
      
      // 네트워크 상태 배지 생성
      const networkBadge = `
        <span id="pdu-network-${uniqueId}" class="badge badge-${isNetworkConnected ? 'success' : 'secondary'}">
          ${isNetworkConnected ? '연결됨' : '연결 안됨'}
        </span>
      `;
      
      // 전원 상태 결정
      const powerStatus = pdu.power_status || 'off';
      const isPowerOn = powerStatus === 'on';
      
      // 전원 상태 배지 생성
      const powerBadge = `
        <span id="pdu-status-${uniqueId}" class="badge badge-${isPowerOn ? 'success' : 'secondary'}">
          ${isPowerOn ? '켜짐' : '꺼짐'}
        </span>
      `;
      
      row.innerHTML = `
        <td class="text-center">${index + 1}</td>
        <td class="text-center">${pdu.name || '-'}</td>
        <td class="text-center">${pdu.ip || '-'}</td>
        <td class="text-center">${networkBadge}</td>
        <td class="text-center">${pdu.port || '-'}</td>
        <td class="text-center">${powerBadge}</td>
        <td class="text-center">
          <div class="control-buttons">
            <button type="button" class="btn control-btn btn-success btn-sm" 
                    onclick="controlPDU('${pdu.ip}', ${pdu.port || 80}, '${pdu.uuid || pdu.id}', 'power_on', '${uniqueId}')">
              <i class="fas fa-power-off mr-1"></i>켜기
            </button>
            <button type="button" class="btn control-btn btn-danger btn-sm" 
                    onclick="controlPDU('${pdu.ip}', ${pdu.port || 80}, '${pdu.uuid || pdu.id}', 'power_off', '${uniqueId}')">
              <i class="fas fa-power-off mr-1"></i>끄기
            </button>
          </div>
        </td>
        <td class="text-center">
          <div class="settings-buttons">
            <button type="button" class="btn control-btn btn-info btn-sm" 
                    onclick="openPDUSettings('${pdu.ip}', ${pdu.port || 80}, '${pdu.uuid || pdu.id}')">
              <i class="fas fa-cog mr-1"></i>설정
            </button>
            <button type="button" class="btn control-btn btn-secondary btn-sm" 
                    onclick="deletePDU('${pdu.ip}', ${pdu.port || 80}, '${pdu.uuid || pdu.id}')">
              <i class="fas fa-trash mr-1"></i>삭제
            </button>
          </div>
        </td>
      `;
      
      pduList.appendChild(row);
    });
  }
  
  // 스피너 숨기기
  hideSpinner() {
    const spinner = document.getElementById('pduSpinner');
    if (spinner) {
      spinner.style.display = 'none';
    }
  }
  
  // PDU 스케줄 저장 함수
  savePDUSchedule() {
    console.log('[PDU] PDU 스케줄 저장 시작');
    
    try {
      // 기존 스케줄 테이블 대신 실제 UI 요소에서 데이터 수집
      const powerOnTime = document.getElementById('start-time').value;
      const powerOffTime = document.getElementById('end-time').value;
      
      // 요일 데이터 수집
      const days = [];
      for (let i = 1; i <= 7; i++) {
        const dayCheckbox = document.getElementById(`day-${i}`);
        if (dayCheckbox && dayCheckbox.checked) {
          days.push(i.toString());
        }
      }
      
      // 필수 데이터 검증
      if (!powerOnTime || !powerOffTime || days.length === 0) {
        this.showNotification('켜기/끄기 시간과 요일을 모두 설정해주세요.', 'error');
        return;
      }
      
      // 요일 문자열 만들기
      const daysStr = days.join(',');
      
      // 서버 요청용 데이터 구성
      const requestData = {
        pdu_id: 'common',
        power_on_time: powerOnTime,
        power_off_time: powerOffTime,
        days: daysStr,
        is_active: document.getElementById('pdu-schedule-active').checked
      };
      
      console.log('[PDU] 서버에 전송할 스케줄 데이터:', requestData);
      
      // 안드로이드 환경 감지
      const androidBridge = window.AndroidBridge || window.AndroidChannel || window.Android;
      
      if (androidBridge) {
        console.log('[PDU] 안드로이드 환경에서 PDU 스케줄 저장');
        try {
          const scheduleDataJson = JSON.stringify(requestData);
          
          if (typeof androidBridge.savePDUSchedule === 'function') {
            androidBridge.savePDUSchedule(scheduleDataJson);
          } else if (typeof androidBridge.postMessage === 'function') {
            androidBridge.postMessage(`savePDUSchedule:${scheduleDataJson}`);
          } else {
            throw new Error('안드로이드 브릿지 메서드를 찾을 수 없음');
          }
          
          this.showNotification('PDU 스케줄 저장 요청을 전송했습니다.', 'info');
        } catch (error) {
          console.error('[PDU] 안드로이드 통신 오류:', error);
          this.showNotification('안드로이드와 통신 중 오류가 발생했습니다.', 'error');
        }
      } else {
        // 웹 환경에서는 API 직접 호출
        fetch('/api/pdu/schedule/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestData)
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`PDU 스케줄 저장에 실패했습니다 (${response.status})`);
          }
          return response.json();
        })
        .then(data => {
          console.log('[PDU] PDU 스케줄 저장 결과:', data);
          if (data.success) {
            this.showNotification('PDU 스케줄이 성공적으로 저장되었습니다.', 'success');
          } else {
            this.showNotification(`PDU 스케줄 저장 실패: ${data.error || '알 수 없는 오류'}`, 'error');
          }
        })
        .catch(error => {
          console.error('[PDU] PDU 스케줄 저장 오류:', error);
          this.showNotification('PDU 스케줄을 저장하는데 실패했습니다.', 'error');
        });
      }
    } catch (error) {
      console.error('[PDU] PDU 스케줄 저장 처리 중 오류:', error);
      this.showNotification('PDU 스케줄 처리 중 오류가 발생했습니다.', 'error');
    }
  }
  
  // 알림 표시 함수
  showNotification(message, type = 'info') {
    // 전역 showNotification 함수 호출
    if (typeof window.showNotification === 'function') {
      window.showNotification(message, type);
    } else {
      alert(message);
    }
  }
  
  // PDU 스케줄 로드 함수 추가
  loadPDUSchedule() {
    console.log('[PDU] PDU 스케줄 로드 시작');
    
    // 안드로이드 환경 감지
    const androidBridge = window.AndroidBridge || window.AndroidChannel || window.Android;
    
    if (androidBridge) {
      console.log('[PDU] 안드로이드 환경에서 PDU 스케줄 로드');
      try {
        if (typeof androidBridge.loadPDUSchedule === 'function') {
          androidBridge.loadPDUSchedule();
        } else if (typeof androidBridge.postMessage === 'function') {
          androidBridge.postMessage('loadPDUSchedule');
        } else {
          console.warn('[PDU] 안드로이드 브릿지가 존재하지만 호출 가능한 메서드를 찾을 수 없음');
          // 기본값 표시
          this.applyDefaultSchedule();
        }
      } catch (error) {
        console.error('[PDU] 안드로이드 통신 오류:', error);
        // 오류 시 기본값 표시
        this.applyDefaultSchedule();
      }
    } else {
      // 웹 환경에서는 API 직접 호출
      console.log('[PDU] 웹 환경에서 스케줄 API 호출');
      fetch('/api/pdu/schedule/list/common', {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' },
        cache: 'no-store'
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`PDU 스케줄을 가져오는데 실패했습니다 (${response.status})`);
        }
        return response.json();
      })
      .then(data => {
        console.log('[PDU] PDU 스케줄 데이터 수신:', data);
        if (data.success) {
          this.updateScheduleUI(data.schedule);
        } else {
          console.error('[PDU] PDU 스케줄 로드 실패:', data.error);
          this.showNotification(`PDU 스케줄 로드 실패: ${data.error || '알 수 없는 오류'}`, 'error');
          // 오류 시 기본값 표시
          this.applyDefaultSchedule();
        }
      })
      .catch(error => {
        console.error('[PDU] PDU 스케줄 로드 오류:', error);
        // 오류 시 기본값 표시
        this.applyDefaultSchedule();
      });
    }
  }
  
  // 서버에서 받은 스케줄 데이터로 UI 업데이트
  updateScheduleUI(schedule) {
    console.log('[PDU] 스케줄 UI 업데이트:', schedule);
    try {
      // 시간 설정
      const startTimeInput = document.getElementById('start-time');
      const endTimeInput = document.getElementById('end-time');
      const scheduleActiveToggle = document.getElementById('pdu-schedule-active');
      
      if (startTimeInput && schedule.power_on_time) {
        startTimeInput.value = schedule.power_on_time;
      }
      
      if (endTimeInput && schedule.power_off_time) {
        endTimeInput.value = schedule.power_off_time;
      }
      
      // 활성화 상태 설정
      if (scheduleActiveToggle) {
        scheduleActiveToggle.checked = schedule.is_active === 1 || schedule.is_active === true;
      }
      
      // 요일 설정 (days 필드는 쉼표로 구분된 숫자)
      if (schedule.days) {
        const selectedDays = schedule.days.split(',');
        
        // 모든 요일 체크박스 초기화
        for (let i = 1; i <= 7; i++) {
          const dayCheckbox = document.getElementById(`day-${i}`);
          if (dayCheckbox) {
            dayCheckbox.checked = selectedDays.includes(i.toString());
          }
        }
      }
    } catch (error) {
      console.error('[PDU] 스케줄 UI 업데이트 중 오류:', error);
    }
  }
  
  // 기본 스케줄 값 적용
  applyDefaultSchedule() {
    console.log('[PDU] 기본 스케줄 값 적용');
    
    const defaultSchedule = {
      power_on_time: '09:00',
      power_off_time: '18:00',
      days: '1,2,3,4,5',
      is_active: true
    };
    
    this.updateScheduleUI(defaultSchedule);
  }
}

// PDU 제어 결과 처리 함수 (네이티브 코드에서도 호출됨)
function handlePDUControlResult(result) {
    console.log('[PDU] 제어 결과:', result);
    
    // 결과에 따라 UI 업데이트
    if (result.success) {
        showNotification(`PDU 제어 명령이 성공적으로 처리되었습니다.`, 'success');
        
        // PDU 상태 업데이트 (uniqueId가 있는 경우)
        if (result.pdu_uuid) {
            const uniqueId = `pdu-${result.pdu_uuid.toString().replace(/\W/g, '')}-${(result.ip || '').replace(/\./g, '-')}`;
            const action = result.action;
            const statusElement = document.getElementById(`pdu-status-${uniqueId}`);
            
            if (statusElement && (action === 'power_on' || action === 'power_off')) {
                const newStatus = action === 'power_on' ? 'on' : 'off';
                statusElement.textContent = newStatus === 'on' ? '켜짐' : '꺼짐';
                statusElement.className = `badge badge-${newStatus === 'on' ? 'success' : 'secondary'}`;
                
                // 최근 제어 상태 저장 - 타임스탬프를 정확히 저장하여 추후에 참조
                window.lastControlledPDUs = window.lastControlledPDUs || {};
                window.lastControlledPDUs[uniqueId] = {
                    timestamp: Date.now(),
                    status: newStatus,
                    power_status: newStatus, // power_status도 명시적으로 업데이트
                    action: action
                };
                
                // PDU 목록 내부 상태 업데이트 - UUID 또는 ID로 검색
                if (window.pduManager && window.pduManager.pdus) {
                    const pdu = window.pduManager.pdus.find(p => 
                        p.uuid === result.pdu_uuid || 
                        p.id === result.pdu_id || 
                        p.id === Number(result.pdu_id)
                    );
                    
                    if (pdu) {
                        console.log(`[PDU] PDU를 찾음: ${pdu.name}, UUID: ${pdu.uuid}, ID: ${pdu.id}`);
                        pdu.status = newStatus;
                        pdu.power_status = newStatus; // power_status 필드도 같이 업데이트
                    } else {
                        console.warn(`[PDU] PDU를 찾을 수 없음: UUID: ${result.pdu_uuid}, ID: ${result.pdu_id}`);
                    }
                }
                
                // 5초 후에 데이터베이스에서 상태가 올바르게 저장되었는지 확인하는 코드 추가
                setTimeout(() => {
                    fetch('/api/pdu/list', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' },
                        cache: 'no-store'
                    })
                    .then(response => response.json())
                    .then(data => {
                        const pdus = data.pdus || [];
                        const controlledPdu = pdus.find(p => p.uuid === result.pdu_uuid);
                        
                        if (controlledPdu) {
                            console.log(`[PDU] 데이터베이스 상태 확인: ${controlledPdu.name}, power_status: ${controlledPdu.power_status}`);
                            
                            // 데이터베이스에 저장된 상태가 제어 결과와 다르면 경고 표시
                            if (controlledPdu.power_status !== newStatus) {
                                console.warn(`[PDU] 데이터베이스 상태 불일치: UI=${newStatus}, DB=${controlledPdu.power_status}`);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('[PDU] 데이터베이스 상태 확인 중 오류:', error);
                    });
                }, 5000);
            }
        }
        
        // 제어 후 3초 후에 PDU 목록 새로고침 (상태 변경 반영을 위해)
        setTimeout(() => {
            console.log('[PDU] 제어 후 PDU 목록 자동 새로고침');
            if (window.pduManager) {
                window.pduManager.loadPDUList();
            }
        }, 3000);
    } else {
        showNotification(`PDU 제어 중 오류가 발생했습니다: ${result.error || '알 수 없는 오류'}`, 'error');
    }
    
    // 모든 PDU 버튼 다시 활성화
    document.querySelectorAll('.control-btn').forEach(btn => btn.disabled = false);
}

// 네트워크 상태만 업데이트하는 함수
function updateNetworkStatus(uniqueId, status) {
  const networkElement = document.getElementById(`pdu-network-${uniqueId}`);
  if (networkElement) {
    networkElement.textContent = status === 'online' ? '연결됨' : '연결 안됨';
    networkElement.className = `badge badge-${status === 'online' ? 'success' : 'secondary'}`;
    networkElement.classList.add('status-changed');
    
    // 애니메이션 효과 제거
    setTimeout(() => {
      networkElement.classList.remove('status-changed');
    }, 500);
  }
}

// 전원 상태만 업데이트하는 함수
function updatePowerStatus(uniqueId, status) {
  const statusElement = document.getElementById(`pdu-status-${uniqueId}`);
  if (statusElement) {
    statusElement.textContent = status === 'on' ? '켜짐' : '꺼짐';
    statusElement.className = `badge badge-${status === 'on' ? 'success' : 'secondary'}`;
    statusElement.classList.add('status-changed');
    
    // 애니메이션 효과 제거
    setTimeout(() => {
      statusElement.classList.remove('status-changed');
    }, 500);
    
    // PDU 객체에서도 상태 업데이트
    if (window.pduManager && window.pduManager.pdus) {
      // uniqueId에서 실제 pdu id 추출
      const pduIdMatch = uniqueId.match(/pdu-([^-]+)/);
      if (pduIdMatch && pduIdMatch[1]) {
        const pduId = pduIdMatch[1];
        const pdu = window.pduManager.pdus.find(p => 
          p.uuid === pduId || 
          p.id === parseInt(pduId) || 
          p.id === pduId
        );
        
        if (pdu) {
          pdu.status = status;
          pdu.power_status = status; // power_status와 status 모두 업데이트
          console.log(`[PDU] PDU ID ${pduId} 상태 업데이트: ${status}`);
        }
      }
    }
  }
}

// PDU 상태 체크 함수 수정
function checkPDUStatus(ip, port, identifier, uniqueId) {
  fetch(`/api/pdu/network/status`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      [isNaN(identifier) ? 'pdu_uuid' : 'pdu_id']: identifier
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // 네트워크 상태만 업데이트
      updateNetworkStatus(uniqueId, data.network_status);
    }
  })
  .catch(error => {
    console.error('PDU 상태 확인 오류:', error);
  });
}

function openPDUSettings(ip, port, identifier) {
  console.log(`[PDU] PDU 설정 페이지 열기: IP=${ip}, 포트=${port}, 식별자=${identifier}`);
  
  // 해당 PDU 찾기 (식별자 기반)
  let pduRow;
  if (isNaN(identifier)) {
    pduRow = document.querySelector(`tr[data-pdu-uuid="${identifier}"]`);
  } else {
    pduRow = document.querySelector(`tr[data-pdu-id="${identifier}"]`);
  }
  
  // PDU 찾지 못한 경우
  if (!pduRow) {
    console.error(`[PDU] 식별자가 ${identifier}인 PDU를 찾을 수 없습니다.`);
    showNotification('해당 PDU를 찾을 수 없습니다.', 'error');
    return;
  }
  
  // PDU 데이터 수집
  const pduId = pduRow.dataset.pduId || '';
  const pduUuid = pduRow.dataset.pduUuid || '';
  const pduName = pduRow.querySelector('td:nth-child(2)').textContent;
  const pduIp = pduRow.querySelector('td:nth-child(3)').textContent;
  const pduPort = pduRow.querySelector('td:nth-child(5)').textContent; // NET상태 열 추가로 인덱스 변경
  
  // 수정 폼 채우기
  const editForm = document.getElementById('edit-pdu-form');
  if (!editForm) {
    console.error('[PDU] 수정 폼을 찾을 수 없습니다.');
    return;
  }
  
  // 폼 필드 설정
  editForm.querySelector('[name="edit-pdu-id"]').value = pduId;
  editForm.querySelector('[name="edit-pdu-uuid"]').value = pduUuid;
  editForm.querySelector('[name="edit-pdu-name"]').value = pduName;
  editForm.querySelector('[name="edit-pdu-ip"]').value = pduIp === '-' ? '' : pduIp;
  editForm.querySelector('[name="edit-pdu-port"]').value = pduPort === '-' ? '80' : pduPort;
  
  // 수정 모달 열기
  const editModal = document.getElementById('editPDUModal');
  editModal.style.display = 'block';
  editModal.classList.add('active');
  document.body.classList.add('modal-open');
}

// PDU 삭제 함수
function deletePDU(ip, port, identifier) {
  console.log(`[PDU] PDU 삭제 시작: IP=${ip}, 포트=${port}, 식별자=${identifier}`);
  
  // 삭제 확인 대화상자
  if (!confirm('정말로 이 PDU를 삭제하시겠습니까?')) {
    return;
  }
  
  // 안드로이드 환경 감지
  const androidBridge = window.AndroidBridge || window.AndroidChannel || window.Android;
  
  // 웹뷰 환경인지 확인
  if (androidBridge) {
    console.log('[PDU] 안드로이드 웹뷰 환경에서 PDU 삭제 요청');
    try {
      // PDU 삭제 데이터
      const pduDeleteData = JSON.stringify({
        ip: ip,
        port: port,
        id: identifier
      });
      
      // 여러 가능한 브릿지 메서드 시도
      if (typeof androidBridge.deletePDU === 'function') {
        // 직접 PDU 삭제 메서드 호출
        androidBridge.deletePDU(pduDeleteData);
      } else if (typeof androidBridge.postMessage === 'function') {
        // 일반 메시지 전송 (액션 포함)
        androidBridge.postMessage(`deletePDU:${pduDeleteData}`);
      } else {
        console.warn('[PDU] 사용 가능한 안드로이드 삭제 메서드를 찾을 수 없음');
        showNotification('안드로이드 연결 오류. 삭제 요청을 처리할 수 없습니다.', 'error');
      }
      
      // 안드로이드 환경에서는 UI 업데이트
      let row;
      if (isNaN(identifier)) {
        row = document.querySelector(`tr[data-pdu-uuid="${identifier}"]`);
      } else {
        row = document.querySelector(`tr[data-pdu-id="${identifier}"]`);
      }
      
      if (row) {
        row.remove();
        showNotification('PDU가 삭제되었습니다.', 'success');
      }
      
      return;
    } catch (e) {
      console.error('[PDU] 안드로이드 통신 오류:', e);
      showNotification('안드로이드 통신 오류가 발생했습니다.', 'error');
    }
    return;
  }
  
  // UI에서 행 찾기 (나중에 삭제 또는 롤백용)
  let row;
  if (isNaN(identifier)) {
    row = document.querySelector(`tr[data-pdu-uuid="${identifier}"]`);
  } else {
    row = document.querySelector(`tr[data-pdu-id="${identifier}"]`);
  }
  
  // 사용자 경험 향상을 위해 행을 회색으로 처리
  if (row) {
    row.style.opacity = '0.5';
  }
  
  // 첫 번째 방법: POST /api/pdu/delete 시도
  tryDeleteWithPost(ip, port, identifier, row);
}

// POST 방식으로 삭제 시도
function tryDeleteWithPost(ip, port, identifier, row) {
  fetch('/api/pdu/delete', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      ip: ip,
      port: port,
      id: identifier
    })
  })
  .then(response => {
    // 응답이 JSON인지 확인
    const contentType = response.headers.get('content-type');
    if (contentType && contentType.includes('application/json')) {
      return response.json();
    } else {
      return response.text().then(text => {
        console.log(`[PDU] 응답 텍스트: ${text}`);
        
        if (text.includes('Route not found')) {
          throw new Error('API 경로를 찾을 수 없습니다.');
        }
        return { success: response.ok, message: text };
      });
    }
  })
  .then(data => {
    console.log('[PDU] POST 방식 삭제 결과:', data);
    
    if (data.success) {
      handleDeleteSuccess(row);
    } else {
      throw new Error(data.error || data.message || '알 수 없는 오류');
    }
  })
  .catch(error => {
    console.error('[PDU] POST 방식 삭제 오류:', error);
    
    // POST 방식이 실패하면 DELETE 방식 시도
    if (error.message === 'API 경로를 찾을 수 없습니다.') {
      console.log('[PDU] DELETE 방식으로 재시도합니다.');
      tryDeleteWithDelete(identifier, row);
    } else {
      handleDeleteError(error, row);
    }
  });
}

// DELETE 방식으로 삭제 시도
function tryDeleteWithDelete(identifier, row) {
  fetch(`/api/pdu/${identifier}`, {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => {
    // 응답이 JSON인지 확인
    const contentType = response.headers.get('content-type');
    if (contentType && contentType.includes('application/json')) {
      return response.json();
    } else {
      return response.text().then(text => {
        console.log(`[PDU] 응답 텍스트: ${text}`);
        try {
          return JSON.parse(text);
        } catch (e) {
          return { success: response.ok, message: text };
        }
      });
    }
  })
  .then(data => {
    console.log('[PDU] DELETE 방식 삭제 결과:', data);
    
    if (data.success || (!data.error && data.message)) {
      handleDeleteSuccess(row);
    } else {
      throw new Error(data.error || data.message || '알 수 없는 오류');
    }
  })
  .catch(error => {
    console.error('[PDU] DELETE 방식 삭제 오류:', error);
    
    // 두 가지 방법 모두 실패하면 로컬에서만 삭제
    console.log('[PDU] 두 방법 모두 실패. UI에서만 삭제합니다.');
    if (row) {
      row.remove();
      showNotification('서버와 통신 오류가 발생했지만, UI에서는 삭제되었습니다.', 'warning');
    } else {
      handleDeleteError(error, row);
    }
  });
}

// 삭제 성공 처리
function handleDeleteSuccess(row) {
  showNotification('PDU가 성공적으로 삭제되었습니다.', 'success');
  
  // UI에서 행 삭제
  if (row) {
    row.remove();
  }
  
  // PDU 목록 다시 로드
  if (window.pduManager) {
    window.pduManager.loadPDUList();
  }
}

// 삭제 실패 처리
function handleDeleteError(error, row) {
  showNotification(`PDU 삭제 실패: ${error.message}`, 'error');
  
  // UI 롤백 (회색 처리 제거)
  if (row) {
    row.style.opacity = '1';
  }
}

// PDU 관리자 인스턴스 생성
document.addEventListener('DOMContentLoaded', () => {
  window.pduManager = new PDUManager();
  window.pduListReceived = false; // 안드로이드에서 PDU 목록 데이터를 받았는지 여부
  
  // 안드로이드로부터 메시지 수신할 수 있도록 윈도우 객체에 함수 추가
  window.receiveAndroidMessage = function(message) {
    try {
      console.log('[PDU] 안드로이드로부터 메시지 수신:', message);
      const data = JSON.parse(message);
      
      if (data.type === 'pdu_list') {
        console.log('[PDU] PDU 목록 데이터 수신:', data.data);
        window.pduListReceived = true;
        
        if (window.pduListTimer) {
          clearTimeout(window.pduListTimer);
        }
        
        // PDU 목록 업데이트
        if (window.pduManager) {
          window.pduManager.updatePDUList(data.data);
        }
      } 
      else if (data.type === 'pdu_status_update') {
        console.log('[PDU] PDU 상태 업데이트 수신:', data.data);
        // PDU 상태 업데이트 처리
        if (data.data && data.data.uuid) {
          const uniqueId = `pdu-${data.data.uuid.toString().replace(/\W/g, '')}-${(data.data.ip || '').replace(/\./g, '-')}`;
          
          // 네트워크 상태 업데이트
          if (data.data.network_status) {
            updateNetworkStatus(uniqueId, data.data.network_status);
          }
          
          // 전원 상태 업데이트
          if (data.data.status || data.data.power_status) {
            const newStatus = data.data.power_status || data.data.status;
            updatePowerStatus(uniqueId, newStatus);
            
            // 내부 PDU 목록에서도 상태 업데이트
            if (window.pduManager && window.pduManager.pdus) {
              const pdu = window.pduManager.pdus.find(p => p.uuid === data.data.uuid);
              if (pdu) {
                pdu.status = newStatus;
                pdu.power_status = newStatus; // power_status와 status 모두 업데이트
              }
            }
          }
        }
      }
      else if (data.type === 'add_pdu_result') {
        console.log('[PDU] PDU 추가 결과 수신:', data.data);
        // PDU 추가 결과 처리
        if (data.data.success) {
          // 성공 메시지 표시
          window.pduManager.showNotification('PDU가 성공적으로 추가되었습니다.', 'success');
          
          // 모달 닫기
          const modal = document.getElementById('addPDUModal');
          if (modal) {
            modal.classList.remove('active');
            modal.style.display = 'none';
            document.body.classList.remove('modal-open');
          }
          
          // PDU 목록 새로고침
          window.pduManager.loadPDUList();
        } else {
          // 실패 메시지 표시
          window.pduManager.showNotification(`PDU 추가 실패: ${data.data.message || '알 수 없는 오류'}`, 'error');
        }
      }
      else if (data.type === 'edit_pdu_result') {
        console.log('[PDU] PDU 수정 결과 수신:', data.data);
        // PDU 수정 결과 처리
        if (data.data.success) {
          // 성공 메시지 표시
          window.pduManager.showNotification('PDU가 성공적으로 수정되었습니다.', 'success');
          
          // 모달 닫기
          const modal = document.getElementById('editPDUModal');
          if (modal) {
            modal.classList.remove('active');
            modal.style.display = 'none';
            document.body.classList.remove('modal-open');
          }
          
          // PDU 목록 새로고침
          window.pduManager.loadPDUList();
        } else {
          // 실패 메시지 표시
          window.pduManager.showNotification(`PDU 수정 실패: ${data.data.message || '알 수 없는 오류'}`, 'error');
        }
      }
      else if (data.type === 'delete_pdu_result') {
        console.log('[PDU] PDU 삭제 결과 수신:', data.data);
        // PDU 삭제 결과 처리
        if (data.data.success) {
          // 성공 메시지 표시
          window.pduManager.showNotification('PDU가 성공적으로 삭제되었습니다.', 'success');
          
          // PDU 목록 새로고침
          window.pduManager.loadPDUList();
        } else {
          // 실패 메시지 표시
          window.pduManager.showNotification(`PDU 삭제 실패: ${data.data.message || '알 수 없는 오류'}`, 'error');
        }
      }
      else if (data.type === 'error') {
        console.error('[PDU] 안드로이드 오류 수신:', data.message);
        window.pduManager.showNotification(`오류: ${data.message || '알 수 없는 오류'}`, 'error');
      }
    } catch (e) {
      console.error('[PDU] 안드로이드 메시지 처리 오류:', e);
      window.pduManager.showNotification('안드로이드 메시지 처리 중 오류가 발생했습니다.', 'error');
    }
  };
  
  // PDU 초기 목록 로드
  window.pduManager.loadPDUList();
  
  // PDU 스케줄 로드
  window.pduManager.loadPDUSchedule();
});

// 웹뷰 내에서 페이지 이동을 처리하는 함수 추가
function navigateToPage(pageName) {
  // 현재 활성화된 메뉴 변경
  activateMenu(pageName);
  
  // 직접 페이지 이동 방식으로 변경 (SPA 방식 제거)
  console.log('페이지 이동:', pageName);
  
  // 네이티브 앱 통신이 있는 경우 시도
  try {
    if (window.AndroidChannel) {
      window.AndroidChannel.postMessage('navigate:' + pageName);
    } else {
      // 일반 브라우저 이동
      window.location.href = pageName;
    }
  } catch (error) {
    console.error('페이지 이동 오류:', error);
    // 오류 발생 시 직접 이동 시도
    window.location.href = pageName;
  }
}

// 현재 페이지에 따라 메뉴 활성화
function activateMenu(pageName) {
  // 모든 메뉴 링크 비활성화
  document.querySelectorAll('.nav-sidebar .nav-link').forEach(link => {
    link.classList.remove('active');
  });
  
  // 현재 페이지에 맞는 메뉴 활성화
  let linkId = "";
  
  switch(pageName) {
    case 'index.html':
    case '':
      linkId = "dashboard-link";
      break;
    case 'dashboard.html':
      linkId = "dashboard-link";
      break;
    case 'projector.html':
      linkId = "projector-link";
      break;
    case 'pc.html':
      linkId = "pc-link";
      break;
    case 'pdu.html':
      linkId = "pdu-link";
      break;
    default:
      linkId = "dashboard-link";
  }
  
  const activeLink = document.getElementById(linkId);
  if (activeLink) {
    activeLink.classList.add('active');
  }
}

// 브라우저 뒤로가기/앞으로가기 처리
window.addEventListener('popstate', function(event) {
  if (event.state && event.state.page) {
    // 페이지 이동 (새로운 함수 사용)
    window.location.href = event.state.page;
  }
});
// 페이지 로드 시 초기 상태 설정
document.addEventListener('DOMContentLoaded', function() {
  // 현재 URL에 맞는 메뉴 활성화
  const currentPath = window.location.pathname;
  const pageName = currentPath.split('/').pop() || 'dashboard.html';
  
  activateMenu(pageName);
  
  // 브라우저 히스토리 상태 설정
  if (history.replaceState) {
    history.replaceState({ page: pageName }, '', pageName);
  }

  // PDU 스케줄 저장 버튼 이벤트 리스너 - PDUManager가 초기화된 후에 설정
  document.querySelector('button[data-action="save-pdu-schedule"]').addEventListener('click', () => {
    if (window.pduManager) {
      window.pduManager.savePDUSchedule();
    } else {
      showNotification('PDU 관리자가 초기화되지 않았습니다.', 'error');
    }
  });
});

// PDU 스케줄 활성화 토글
document.getElementById('pdu-schedule-active').addEventListener('change', function() {
  // 체크박스 상태 토글 전에 현재 상태 저장
  const currentState = this.checked;
  console.log(`PDU 스케줄 활성화 상태 변경: ${currentState ? '활성화' : '비활성화'}`);
  
  // API 요청을 보내고 서버 응답에 따라 체크박스 상태를 조정
  (async () => {
    try {
      const response = await fetch('/api/pdu/schedule/toggle', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_active: currentState })
      });
      
      const data = await response.json();
      if (data.success) {
        // 성공 시 상태 유지
        showNotification(`PDU 스케줄이 ${currentState ? '활성화' : '비활성화'}되었습니다.`, 'success');
      } else {
        // 실패 시 체크박스 상태 원복
        this.checked = !currentState;
        showNotification(`PDU 스케줄 ${currentState ? '활성화' : '비활성화'} 실패: ${data.error || '알 수 없는 오류'}`, 'error');
      }
    } catch (error) {
      console.error('PDU 스케줄 토글 오류:', error);
      // 오류 시 체크박스 상태 원복
      this.checked = !currentState;
      showNotification(`PDU 스케줄 ${currentState ? '활성화' : '비활성화'} 중 오류가 발생했습니다.`, 'error');
    }
  })();
});

// PDU 제어 전역 함수
function controlPDU(ip, port, identifier, action, uniqueId) {
    console.log(`[PDU] PDU 제어: IP=${ip}, 포트=${port}, 식별자=${identifier}, 액션=${action}, 고유ID=${uniqueId}`);
    
    // 모든 버튼 비활성화 (중복 클릭 방지)
    document.querySelectorAll('.control-btn').forEach(btn => btn.disabled = true);
    
    // 안드로이드 환경 감지
    const androidBridge = window.AndroidBridge || window.AndroidChannel || window.Android;
    
    // 웹뷰 환경인지 확인
    if (androidBridge) {
        console.log('[PDU] 안드로이드 웹뷰 환경에서 PDU 제어 요청');
        try {
            // PDU 제어 데이터
            const pduControlData = JSON.stringify({
                ip: ip,
                port: port,
                id: identifier,
                action: action,
                uniqueId: uniqueId
            });
            
            // 여러 가능한 브릿지 메서드 시도
            if (typeof androidBridge.controlPDU === 'function') {
                // 직접 PDU 제어 메서드 호출
                androidBridge.controlPDU(pduControlData);
            } else if (typeof androidBridge.postMessage === 'function') {
                // 일반 메시지 전송 (액션 포함)
                androidBridge.postMessage(`controlPDU:${pduControlData}`);
            } else {
                console.warn('[PDU] 사용 가능한 안드로이드 제어 메서드를 찾을 수 없음');
                showNotification('안드로이드 연결 오류. 제어 요청을 처리할 수 없습니다.', 'error');
                document.querySelectorAll('.control-btn').forEach(btn => btn.disabled = false);
            }
            
            // UI 즉시 업데이트 (사용자 경험 향상)
            const statusElement = document.getElementById(`pdu-status-${uniqueId}`);
            if (statusElement) {
                // 상태 변경 애니메이션 추가
                statusElement.classList.add('status-changed');
                
                // 제어 요청에 따라 상태 표시 변경
                const newStatus = action === 'power_on' ? 'on' : 'off';
                statusElement.textContent = newStatus === 'on' ? '켜짐' : '꺼짐';
                statusElement.className = `badge badge-${newStatus === 'on' ? 'success' : 'secondary'} status-changed`;
                
                // 애니메이션 효과 제거
                setTimeout(() => {
                    statusElement.classList.remove('status-changed');
                }, 500);
                
                // 최근 제어 상태 저장
                window.lastControlledPDUs = window.lastControlledPDUs || {};
                window.lastControlledPDUs[uniqueId] = {
                    timestamp: Date.now(),
                    status: newStatus,
                    power_status: newStatus,
                    action: action
                };
                
                // PDU 객체 상태도 업데이트
                if (window.pduManager && window.pduManager.pdus) {
                    const pdu = window.pduManager.pdus.find(p => 
                        p.uuid === identifier || 
                        p.id === identifier || 
                        p.id === Number(identifier)
                    );
                    
                    if (pdu) {
                        pdu.status = newStatus;
                        pdu.power_status = newStatus;
                    }
                }
            }
            
            return;
        } catch (error) {
            console.error('[PDU] 안드로이드 통신 오류:', error);
            showNotification('안드로이드 통신 오류가 발생했습니다.', 'error');
            document.querySelectorAll('.control-btn').forEach(btn => btn.disabled = false);
            return;
        }
    }
    
    // 웹 환경에서 API 직접 호출
    fetch('/api/pdu/control', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            ip: ip,
            port: port,
            uniqueId: identifier,
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('[PDU] 제어 결과:', data);
        handlePDUControlResult(data);
    })
    .catch(error => {
        console.error('[PDU] 제어 오류:', error);
        showNotification('PDU 제어 중 오류가 발생했습니다.', 'error');
        document.querySelectorAll('.control-btn').forEach(btn => btn.disabled = false);
    });
}

// 테스트 목적의 PDU 제어 핸들러 (안드로이드에서 자바스크립트를 직접 호출할 때)
function pdaControlCallback(result) {
  try {
    console.log('[PDU] 안드로이드에서 제어 결과 수신:', result);
    const data = typeof result === 'string' ? JSON.parse(result) : result;
    
    // 결과 처리
    if (data.success) {
      // 성공 메시지
      showNotification('PDU 제어가 성공적으로 완료되었습니다.', 'success');
      
      // PDU 상태 업데이트
      if (data.uniqueId && data.action) {
        const statusElement = document.getElementById(`pdu-status-${data.uniqueId}`);
        if (statusElement) {
          const newStatus = data.action === 'power_on' ? 'on' : 'off';
          statusElement.textContent = newStatus === 'on' ? '켜짐' : '꺼짐';
          statusElement.className = `badge badge-${newStatus === 'on' ? 'success' : 'secondary'}`;
        }
      }
    } else {
      // 실패 메시지
      showNotification(`PDU 제어 실패: ${data.error || '알 수 없는 오류'}`, 'error');
    }
    
    // 버튼 다시 활성화
    document.querySelectorAll(`.control-btn`).forEach(btn => btn.disabled = false);
    
  } catch (e) {
    console.error('[PDU] 제어 결과 처리 오류:', e);
    showNotification('PDU 제어 결과 처리 중 오류가 발생했습니다.', 'error');
    
    // 버튼 다시 활성화
    document.querySelectorAll(`.control-btn`).forEach(btn => btn.disabled = false);
  }
}

// 안드로이드 웹뷰 환경에서 호출할 수 있도록 전역 등록
window.pdaControlCallback = pdaControlCallback;

// PDU 수정 함수
function editPDU(uuid) {
  console.log(`[PDU] PDU 수정 시작: UUID=${uuid}`);
  
  // 해당 PDU 찾기
  const pduRow = document.querySelector(`tr[data-pdu-uuid="${uuid}"]`);
  if (!pduRow) {
    console.error(`[PDU] UUID가 ${uuid}인 PDU를 찾을 수 없습니다.`);
    showNotification('해당 PDU를 찾을 수 없습니다.', 'error');
    return;
  }
  
  // PDU 데이터 수집
  const pduId = pduRow.dataset.pduId;
  const pduName = pduRow.querySelector('td:nth-child(2)').textContent;
  const pduIp = pduRow.querySelector('td:nth-child(3)').textContent;
  const pduPort = pduRow.querySelector('td:nth-child(4)').textContent;
  const outletCount = pduRow.querySelector('td:nth-child(5)').textContent;
  
  console.log(`[PDU] 수정할 PDU 데이터: 이름=${pduName}, IP=${pduIp}, 포트=${pduPort}, 아웃렛=${outletCount}`);
  
  // 수정 폼 채우기
  const editForm = document.getElementById('edit-pdu-form');
  if (!editForm) {
    console.error('[PDU] 수정 폼을 찾을 수 없습니다.');
    return;
  }
  
  // 폼 필드 설정
  editForm.querySelector('[name="edit-pdu-id"]').value = pduId;
  editForm.querySelector('[name="edit-pdu-uuid"]').value = uuid;
  editForm.querySelector('[name="edit-pdu-name"]').value = pduName;
  editForm.querySelector('[name="edit-pdu-ip"]').value = pduIp === '-' ? '' : pduIp;
  editForm.querySelector('[name="edit-pdu-port"]').value = pduPort === '-' ? '80' : pduPort;
  editForm.querySelector('[name="edit-pdu-model"]').value = 'ATEN PE6108';
  editForm.querySelector('[name="edit-pdu-username"]').value = 'administrator';
  editForm.querySelector('[name="edit-pdu-outlet-count"]').value = outletCount || '8';
  editForm.querySelector('[name="edit-pdu-password"]').value = '';
  
  console.log('[PDU] 수정 폼 데이터 설정 완료');
  
  // 모달 열기
  const editModal = document.getElementById('editPDUModal');
  console.log('[PDU] 수정 모달 요소:', editModal);
  
  if (editModal) {
    editModal.style.display = 'block';
    editModal.classList.add('active');
    document.body.classList.add('modal-open');
    console.log('[PDU] 수정 모달이 열렸습니다.', editModal.style.display);
    
    // 이벤트 리스너 확인
    const cancelButton = editModal.querySelector('button[onclick="cancelEditPDU()"]');
    const saveButton = editModal.querySelector('button[onclick="saveEditPDU()"]');
    
    console.log('[PDU] 취소 버튼:', cancelButton);
    console.log('[PDU] 저장 버튼:', saveButton);
  } else {
    console.error('[PDU] 수정 모달을 찾을 수 없습니다.');
  }
}

// PDU 수정 취소
function cancelEditPDU() {
  console.log('[PDU] 수정 취소');
  // 모달 닫기
  const editModal = document.getElementById('editPDUModal');
  editModal.style.display = 'none';
  editModal.classList.remove('active');
  document.body.classList.remove('modal-open');
  console.log('[PDU] 수정 모달 닫힘');
}

// PDU 수정 저장
function saveEditPDU() {
  console.log('[PDU] PDU 수정 저장');
  
  // 폼 데이터 가져오기
  const editForm = document.getElementById('edit-pdu-form');
  if (!editForm) {
    console.error('[PDU] 수정 폼을 찾을 수 없습니다.');
    return;
  }
  
  // 폼 데이터 수집
  const formData = new FormData(editForm);
  const pduData = {
    id: formData.get('edit-pdu-id'),
    uuid: formData.get('edit-pdu-uuid'),
    name: formData.get('edit-pdu-name'),
    ip: formData.get('edit-pdu-ip'),
    port: formData.get('edit-pdu-port')
  };
  
  // 유효성 검사
  if (!pduData.name || !pduData.ip || !pduData.port) {
    showNotification('모든 필수 필드를 입력해주세요.', 'error');
    return;
  }
  
  // 안드로이드 환경 감지
  const androidBridge = window.AndroidBridge || window.AndroidChannel || window.Android;
  
  // 웹뷰 환경인지 확인
  if (androidBridge) {
    console.log('[PDU] 안드로이드 웹뷰 환경에서 PDU 수정 요청');
    try {
      // PDU 수정 데이터
      const pduEditData = JSON.stringify(pduData);
      
      // 여러 가능한 브릿지 메서드 시도
      if (typeof androidBridge.editPDU === 'function') {
        // 직접 PDU 수정 메서드 호출
        androidBridge.editPDU(pduEditData);
      } else if (typeof androidBridge.postMessage === 'function') {
        // 일반 메시지 전송 (액션 포함)
        androidBridge.postMessage(`editPDU:${pduEditData}`);
      } else {
        console.warn('[PDU] 사용 가능한 안드로이드 수정 메서드를 찾을 수 없음');
        showNotification('안드로이드 연결 오류. 수정 요청을 처리할 수 없습니다.', 'error');
      }
    } catch (e) {
      console.error('[PDU] 안드로이드 통신 오류:', e);
      showNotification('안드로이드 통신 오류가 발생했습니다.', 'error');
    }
    
    // 모달 닫기
    cancelEditPDU();
    return;
  }
  
  // 웹 환경에서는 API 직접 호출
  fetch('/api/pdu/update', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(pduData)
  })
  .then(response => response.json())
  .then(data => {
    console.log('[PDU] 수정 결과:', data);
    if (data.success) {
      showNotification('PDU가 성공적으로 수정되었습니다.', 'success');
      
      // PDU 목록 새로고침
      if (window.pduManager) {
        window.pduManager.loadPDUList();
      }
    } else {
      showNotification(`PDU 수정 실패: ${data.error || '알 수 없는 오류'}`, 'error');
    }
  })
  .catch(error => {
    console.error('[PDU] 수정 오류:', error);
    showNotification(`PDU 수정 중 오류가 발생했습니다: ${error.message}`, 'error');
  })
  .finally(() => {
    // 모달 닫기
    cancelEditPDU();
  });
}

// PDU 설정 페이지 열기
function openPDUSettings(ip, port, identifier) {
  console.log(`[PDU] PDU 설정 페이지 열기: IP=${ip}, 포트=${port}, 식별자=${identifier}`);
  
  // 안드로이드 환경에서는 네이티브 설정 페이지 열기
  const androidBridge = window.AndroidBridge || window.AndroidChannel || window.Android;
  if (androidBridge) {
    try {
      // PDU 설정 데이터
      const pduSettingsData = JSON.stringify({
        ip: ip,
        port: port,
        id: identifier
      });
      
      // 여러 가능한 브릿지 메서드 시도
      if (typeof androidBridge.openPDUSettings === 'function') {
        androidBridge.openPDUSettings(pduSettingsData);
      } else if (typeof androidBridge.postMessage === 'function') {
        androidBridge.postMessage(`openPDUSettings:${pduSettingsData}`);
      } else {
        console.warn('[PDU] 사용 가능한 안드로이드 설정 메서드를 찾을 수 없음');
        // 웹 페이지로 대체
        window.open(`/pdu_settings.html?ip=${ip}&port=${port}&id=${identifier}`, '_blank');
      }
    } catch (e) {
      console.error('[PDU] 안드로이드 통신 오류:', e);
      showNotification('안드로이드 통신 오류가 발생했습니다.', 'error');
    }
    return;
  }
  
  // 웹 환경에서는 별도 페이지 열기
  window.open(`/pdu_settings.html?ip=${ip}&port=${port}&id=${identifier}`, '_blank');
}

// 알림 표시 함수
function showNotification(message, type = 'info') {
  console.log(`[알림] ${type}: ${message}`);
  
  // 알림 요소 생성
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.innerHTML = `
    <div class="notification-icon">
      <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'info-circle'}"></i>
        </div>
    <div class="notification-message">${message}</div>
    <button class="notification-close" onclick="this.parentNode.remove()">×</button>
  `;
  
  // 알림 컨테이너에 추가
  let container = document.getElementById('notification-container');
  if (!container) {
    container = document.createElement('div');
    container.id = 'notification-container';
    document.body.appendChild(container);
  }
  
  container.appendChild(notification);
  
  // 5초 후 자동으로 제거
  setTimeout(() => {
    notification.classList.add('notification-hide');
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 5000);
}

// DOMContentLoaded 이벤트에 편집 모달 이벤트 핸들러 추가
document.addEventListener('DOMContentLoaded', () => {
  // 폼 제출 이벤트 방지
  const editForm = document.getElementById('edit-pdu-form');
  if (editForm) {
    editForm.addEventListener('submit', (e) => {
      e.preventDefault();
      saveEditPDU();
    });
  }
  
  // 취소 버튼 클릭 이벤트
  const cancelButton = document.querySelector('[data-action="cancel-edit-pdu"]');
  if (cancelButton) {
    cancelButton.addEventListener('click', (e) => {
      e.preventDefault();
      cancelEditPDU();
    });
  }
  
  // 저장 버튼 클릭 이벤트
  const saveButton = document.querySelector('[data-action="save-edit-pdu"]');
  if (saveButton) {
    saveButton.addEventListener('click', (e) => {
      e.preventDefault();
      saveEditPDU();
    });
  }
  
  // PDU 추가 버튼 클릭 이벤트
  document.querySelectorAll('[data-action="open-modal"]').forEach(button => {
    button.addEventListener('click', () => {
      const modalId = button.getAttribute('data-modal');
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.add('active');
        modal.style.display = 'block';
        document.body.classList.add('modal-open');
      }
    });
  });
  
  // PDU 추가 모달 닫기 버튼 클릭 이벤트
  document.querySelectorAll('[data-action="close-modal"]').forEach(button => {
    button.addEventListener('click', () => {
      const modal = button.closest('.js-modal');
      if (modal) {
        modal.classList.remove('active');
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
      }
    });
  });
  
  // PDU 추가 버튼 클릭 이벤트 (새로운 방식)
  document.querySelectorAll('[data-action="open-add-pdu-modal"]').forEach(button => {
    button.addEventListener('click', () => {
      console.log("PDU 추가 버튼 클릭됨");
      const modal = document.getElementById('addPDUModal');
      if (modal) {
        modal.classList.add('active');
        modal.style.display = 'block';
        document.body.classList.add('modal-open');
      } else {
        console.error("addPDUModal을 찾을 수 없습니다.");
      }
    });
  });
});

// PDU 추가 함수
function addPDU() {
  console.log('[PDU] PDU 추가 시작');
  
  // 폼 데이터 가져오기
  const addForm = document.getElementById('add-pdu-form');
  if (!addForm) {
    console.error('[PDU] 추가 폼을 찾을 수 없습니다.');
    return;
  }
  
  // 폼 데이터 수집
  const formData = new FormData(addForm);
  const pduData = {
    name: formData.get('pdu-name'),
    ip: formData.get('pdu-ip'),
    port: formData.get('pdu-port'),
    model: formData.get('pdu-model'),
    username: formData.get('pdu-username') || 'administrator',
    password: formData.get('pdu-password') || 'password'
  };
  
  // 유효성 검사
  if (!pduData.name || !pduData.ip || !pduData.port) {
    showNotification('모든 필수 필드를 입력해주세요.', 'error');
    return;
  }
  
  // 안드로이드 환경 감지
  const androidBridge = window.AndroidBridge || window.AndroidChannel || window.Android;
  
  // 웹뷰 환경인지 확인
  if (androidBridge) {
    console.log('[PDU] 안드로이드 웹뷰 환경에서 PDU 추가 요청');
    try {
      // PDU 추가 데이터
      const pduAddData = JSON.stringify(pduData);
      
      // 여러 가능한 브릿지 메서드 시도
      if (typeof androidBridge.addPDU === 'function') {
        // 직접 PDU 추가 메서드 호출
        androidBridge.addPDU(pduAddData);
      } else if (typeof androidBridge.postMessage === 'function') {
        // 일반 메시지 전송 (액션 포함)
        androidBridge.postMessage(`addPDU:${pduAddData}`);
      } else {
        console.warn('[PDU] 사용 가능한 안드로이드 추가 메서드를 찾을 수 없음');
        showNotification('안드로이드 연결 오류. 추가 요청을 처리할 수 없습니다.', 'error');
      }
    } catch (e) {
      console.error('[PDU] 안드로이드 통신 오류:', e);
      showNotification('안드로이드 통신 오류가 발생했습니다.', 'error');
    }
    
    // 모달 닫기
    const modal = document.getElementById('addPDUModal');
    if (modal) {
      modal.classList.remove('active');
      modal.style.display = 'none';
      document.body.classList.remove('modal-open');
    }
    
    return;
  }
  
  // 웹 환경에서는 API 직접 호출
  fetch('/api/pdu/add', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(pduData)
  })
  .then(response => response.json())
  .then(data => {
    console.log('[PDU] 추가 결과:', data);
    if (data.success) {
      showNotification('PDU가 성공적으로 추가되었습니다.', 'success');
      
      // PDU 목록 새로고침
      if (window.pduManager) {
        window.pduManager.loadPDUList();
      }
      
      // 폼 초기화
      addForm.reset();
    } else {
      showNotification(`PDU 추가 실패: ${data.error || '알 수 없는 오류'}`, 'error');
    }
  })
  .catch(error => {
    console.error('[PDU] 추가 오류:', error);
    showNotification(`PDU 추가 중 오류가 발생했습니다: ${error.message}`, 'error');
  })
  .finally(() => {
    // 모달 닫기
    const modal = document.getElementById('addPDUModal');
    if (modal) {
      modal.classList.remove('active');
      modal.style.display = 'none';
      document.body.classList.remove('modal-open');
    }
  });
}

// 모달 열기 함수
function openModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.style.display = 'block';
    modal.classList.add('active');
    document.body.classList.add('modal-open');
  }
}

// 모달 닫기 함수
function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.style.display = 'none';
    modal.classList.remove('active');
    document.body.classList.remove('modal-open');
  }
}

// PDU 추가 모달의 추가 버튼 클릭 이벤트
const addPduBtn = document.querySelector('[data-action="add-pdu"]');
if (addPduBtn) {
  addPduBtn.addEventListener('click', () => {
    console.log("PDU 추가 버튼 클릭됨");
    addPDU();
  });
} else {
  console.error("PDU 추가 버튼을 찾을 수 없습니다.");
}

// PDU 추가 버튼에 모달 열기 기능 직접 추가
document.addEventListener('DOMContentLoaded', function() {
  const addPDUButton = document.getElementById('addPDUButton');
  if (addPDUButton) {
    addPDUButton.addEventListener('click', function() {
      console.log('PDU 추가 버튼 클릭됨');
      const modal = document.getElementById('addPDUModal');
      if (modal) {
        modal.style.display = 'block';
        modal.classList.add('active');
        document.body.classList.add('modal-open');
      } else {
        console.error('addPDUModal을 찾을 수 없습니다');
      }
    });
  }
});
</script>
</body>
</html>

